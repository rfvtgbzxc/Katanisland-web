function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function init_webscoket(e){ws=new WebSocket(websocket_url+"/"+room_pswd+"/"+user_index+"/"),load_ws_function_msg(),load_ws_function_link(),ws.onopen=function(){e()}}function member_handle_msg(e){switch(e.change){case"relink":player_relink(e.value[0]);break;case"ready":player_ready(e.value[0]);break;case"audience_join":audience_join(e.value[0])}}function player_relink(e){if(0!=game_info.game_process){var t=game_info.user_list[e],i=game_info.players[t];his_window.push(i.name+" 重新连接","important"),his_window.push("等待玩家加载游戏..."),$("wait_window").show()}}function player_ready(e){if(0!=game_info.game_process){var t=game_info.user_list[e],i=game_info.players[t];his_window.push(i.name+" 加载完成","important"),$("wait_window").hide()}}function load_ws_function_link(){ws.onclose=function(){his_window.push("与服务器连接断开","important"),alert("与服务器连接断开!")}}function audience_join(e){$("#hide_audience_mes input").is(":checked")||his_window.push(e+" 加入观战","important")}function DataManager(){throw new Error("This is a static class")}function load_game_offline(){load_ws_function_msg(),request_t_game_info()}function request_t_game_info(){$.ajax({async:!1,url:"/ajax/t_load_game/",type:"get",data:"&room_pswd="+room_pswd,dataType:"json",headers:{"X-CSRFToken":$.cookie("csrftoken")},success:function(e){map_info=e.map_info,DataManager.extractSaveContents(e.game_info);for(player_index in game_info.players)ready_list[player_index]=!1;load_map(),load_UI(),init_t_ui(),$("#basic_cmd").hide(),offline||$gameSystem.is_audience()||ws.sendmsg("mes_member",{change:"ready",value:[user_index,user_name]})}})}function init_t_ui(){switch(debug||($("#debuging").hide(),$("#debug_show_ids").hide(),$("#debug_show_selectors").hide()),$gameSystem.is_audience()?$("his_input_window").hide():$("source_list").show(),$("dice").show(),$("his_window").show(),hide_special_actions(),clear_selectors(),update_static_Graphic(),timer.reset(),$gameSystem.game_process){case 0:break;case 1:if(!$gameSystem.is_audience())if(UI_start_dice(),0!=$gameSystem.self_player().first_dice[0]){var e=$gameSystem.self_player().first_dice,t=e[0]+e[1];his_window.push("正在确定行动顺序,你已投骰,共计 "+t,"important"),UI_set_dices(e[0],e[1])}else his_window.push("所有玩家准备就绪,开始确定行动顺序,请投骰子：","important");break;case 2:if(create_step_list(),!$gameSystem.is_audience()&&$gameSystem.is_own_turn()){var i=$gameSystem.active_player().own_cities;UI_start_set_home($gameSystem.active_player().home_step,i[i.length-1])}break;case 3:if(create_step_list(),UI_begin_turn(),0!=$gameSystem.dice_num[0]){if(UI_set_dices($gameSystem.dice_num[0],$gameSystem.dice_num[1]),0!=$gameSystem.dice_7_step){$gameSystem.is_audience()||(1==$gameSystem.dice_7_step&&0!=$gameSystem.self_player().drop_required?start_drop_select():2==$gameSystem.dice_7_step&&$gameSystem.is_own_turn()&&start_robber_set());break}if(UI_start_build(),!$gameSystem.is_audience()){var a=!0,s=!1,n=void 0;try{for(var r,o=$gameSystem.active_trades[Symbol.iterator]();!(a=(r=o.next()).done);a=!0){var _=r.value,c=$gameTrades[_];if(c.accepter==user_index){his_window.push($gamePlayers[c.starter].name+" 想要与你交易","important"),show_special_actions("trade",c.starter);break}}}catch(e){s=!0,n=e}finally{try{!a&&o.return&&o.return()}finally{if(s)throw n}}}}}}function debug_handel_msg(e){switch(e.type){case"mes_member":switch(e.message.change){case"ready":t_player_ready(e.message.value[0],e.message.value[1])}}}function t_player_ready(e,t){if(0==game_info.game_process&&0==ready_list[e]){$gameSystem.is_audience()||ws.sendmsg("mes_member",{change:"ready",value:[user_index,user_name]}),ready_list[e]=!0;game_info.players[e].name=t,game_info.player_list[e][1]=t,$("playername").filter("#"+e).text(""+t),$("button").filter(function(){return"player"==$(this).attr("trade_target")&&$(this).attr("target_val")==e}).text(""+t),his_window.push("序号"+e+", "+t+" 准备就绪");var i=!0;for(var a in ready_list)if(!ready_list[a]){i=!1;break}i&&($youziku.submit("playername_fst_update"),his_window.push("所有玩家准备就绪,开始确定行动顺序,请投骰子：","important"),$gameSystem.recive_list=[].concat(game_info.online_list),game_info.game_process=1,UI_start_dice())}}function upload_game_info(){var e=DataManager.makeSaveContents();$.ajax({type:"post",url:"/ajax/t_update_game_info/",data:{room_pswd:room_pswd,game_info:JSON.stringify(e)},async:!1,headers:{"X-CSRFToken":$.cookie("csrftoken")},error:function(){alert("更新服务器数据失败!")}})}function update_static_Graphic(){if(!$gameSystem.is_audience()){for(var e=game_info.players[user_index],t=1;t<6;t++)$(".src_"+order[t]).children().filter("truely_own").text(""+e[order[t]+"_num"]);$("#action_use_dev_soldier").children().filter(".dev_num").text(""+e.soldier_num),$("#action_use_dev_plenty").children().filter(".dev_num").text(""+e.plenty_num),$("#action_use_dev_monopoly").children().filter(".dev_num").text(""+e.monopoly_num),$("#action_use_dev_road_making").children().filter(".dev_num").text(""+e.road_making_num),$("#action_show_score_cards").children().filter(".dev_num").text(""+e.score_unshown.length)}$("player").each(function(){var e=$(this).attr("id"),t=game_info.players[e],i=$(this).children();i.filter("src_state").text(""+all_src_num(t)),i.filter("vp_state").text(""+vp_num(e)),i.filter("dev_state").text(""+all_dev_num(t)),i.filter("city0_state").text(""+t.city_num(0)),i.filter("city1_state").text(""+t.city_num(1)),game_info.longest_road==e?i.filter("longest_road").addClass("active"):i.filter("longest_road").removeClass("active"),game_info.max_minitory==e?i.filter("max_minitory").addClass("active"):i.filter("max_minitory").removeClass("active"),t.score_shown.length>0?i.filter("score_card").addClass("active"):i.filter("score_card").removeClass("active")}),$(".city").each(function(){var e=game_info.cities[$(this).attr("id")];$(this).attr("src","/media/img/city_lv"+e.level+"_"+color_reflection[e.owner]+".png")}),set_robber(game_info.occupying),("action_drop_srcs_for_7"!=game_temp.action_now||offline)&&$("wait_window").hide()}function clear_selectors(){$("plc_selector").attr("tip","").removeClass("active selector_available selector_selected selector_disabled selector_displaying").hide(),$("edge_selector").attr("tip","").removeClass("active selector_available selector_selected selector_disabled selector_displaying").hide(),$("pt_selector").attr("tip","").removeClass("active selector_available selector_selected selector_disabled selector_displaying").hide(),$("player").removeClass("active player_select_available player_select_selected")}function cancel_selectors(){$("plc_selector").removeClass("selector_selected"),$("edge_selector").removeClass("selector_selected"),$("pt_selector").removeClass("selector_selected"),$("player").removeClass("player_select_selected")}function turn_rounds(){var e=(game_info.player_list,game_info.players,game_info.step_list),t=parseInt(game_info.step_list.length/2);$("step_list").append("<steper pos='"+(t+1)+"'></steper>");var i=$("steper").filter(function(){return $(this).attr("pos")==t+1}),a=last_step_index+parseInt(i.attr("pos"));a>game_info.step_list.length-1&&(a-=game_info.step_list.length),player_index=e[a],player_index==user_index&&i.addClass("self"),i.css("color",color_reflection_hex[color_reflection[player_index]]),i.css({left:45*e.length+65,height:"1px",width:"1px"}),$("steper").each(function(){"1"==$(this).attr("pos")?$(this).animate({left:"-=65px",top:"0",height:"60px",width:"60px"},function(){last_step_index++,last_step_index==game_info.step_list.length&&(last_step_index=0),last_step_index!=game_info.step_index&&turn_rounds()}):"0"==$(this).attr("pos")?($(this).animate({left:"-=45px",top:"12px",height:"40px",width:"40px"}),$(this).removeClass("ownround")):$(this).attr("pos")==t+1?$(this).animate({left:"-=45px",height:"40px",width:"40px"}):$(this).attr("pos")==-t?$(this).animate({left:"-=45px",height:"1px",width:"1px"},function(){$(this).remove()}):$(this).animate({left:"-=45px"}),$(this).attr("pos",parseInt($(this).attr("pos"))-1)})}function load_map(){$("#seed_id").text(""+map_info.rand_seed),places=map_info.places,edges=map_info.edges,points=map_info.points,harbors=map_info.harbors,cities=game_info.cities,roads=game_info.roads,xsize=map_info.xsize,ysize=map_info.ysize,set_robber(game_info.occupying);for(var e in places){var t=parseInt(e/ysize),i=e%ysize,a=places[e],s=Math.round(t*edge_size*1.5),n=Math.round(i*edge_size*1.732+t%2*.5*1.732*edge_size),r=0,o=0;$("#places").append("<img class='plc' id='"+e+"' src='"+cdn_url+"/media/img/hexagon.png'/>"),plc=$(".plc").filter("#"+e),plc.after("<plc_selector id='"+e+"'></plc_selector>"),plc.after("<img class='backpic' id='"+e+"' src='"+cdn_url+"/media/img/"+order[a.create_type]+".png'/>"),0!=a.create_num&&plc.after("<img class='numpic' id='"+e+"' src='"+cdn_url+"/media/img/num_"+a.create_num+".png'/>"),plc.css({left:s+"px",top:n+"px","z-index":"500"}),$("plc_selector").filter("#"+e).css({left:s+"px",top:n+"px","z-index":"2000"}),$(".backpic").filter("#"+e).css({left:s+"px",top:n+"px","z-index":"200"}),$(".numpic").filter("#"+e).css({left:s+"px",top:n+"px","z-index":"300"})}for(var _ in edges){var r,o,c=edges[_],e=parseInt(c/3),t=parseInt(e/ysize),i=e%ysize,a=places[e],s=Math.round(t*edge_size*1.5),n=Math.round(i*edge_size*1.732+t%2*.5*1.732*edge_size);switch($("#edges").append("<edge_selector class='dir_"+c%3+"' id='"+c+"'></edge_selector>"),c%3){case 0:r=0,o=0;break;case 1:r=Math.round(.5*edge_size),o=-6;break;case 2:r=Math.round(1.5*edge_size),o=0}roads.hasOwnProperty(c)&&add_road(c),$("edge_selector").filter("#"+c).css({left:s+r+"px",top:n+o+"px","z-index":"3000"})}for(var l in points){var r,o,d=points[l],e=parseInt(d/2),t=parseInt(e/ysize),i=e%ysize,a=places[e],s=Math.round(t*edge_size*1.5),n=Math.round(i*edge_size*1.732+t%2*.5*1.732*edge_size);switch($("#points").append("<pt_selector id='"+d+"'></pt_selector>"),d%2){case 0:r=Math.round(.5*edge_size)-29,o=-30;break;case 1:r=Math.round(1.5*edge_size)-28,o=-30}cities.hasOwnProperty(d)&&add_city(d),$("pt_selector").filter("#"+d).css({left:s+r+"px",top:n+o+"px","z-index":"3000"})}for(var m=0;m<harbors.length;m++){var p=harbors[m],e=p.place_id,t=parseInt(e/ysize),i=e%ysize,a=places[e],s=Math.round(t*edge_size*1.5),n=Math.round(i*edge_size*1.732+t%2*.5*1.732*edge_size),r=0,o=0;$("#harbors").append("<img class='harbor' id='"+m+"' src='"+cdn_url+"/media/img/harbor_"+p.direct+".png'/>"),hbr=$(".harbor").filter("#"+m);var u;switch(u=6!=p.ex_type?2:3,hbr.after("<img class='hb_num' id='"+m+"' src='"+cdn_url+"/media/img/harbor_num"+u+"_"+p.direct+".png'/>"),hbr.after("<img class='hb_icon' id='"+m+"' src='"+cdn_url+"/media/img/harbor_icon_"+p.ex_type+".png'/>"),p.direct){case"up":r=182,o=5;break;case"dn":r=175,o=295;break;case"lu":r=55,o=73;break;case"ld":r=52,o=223;break;case"ru":r=305,o=78;break;case"rd":r=301,o=227}var f=s-2*edge_size,h=Math.round(n-1.732*edge_size);$(".harbor").filter("#"+m).css({left:f+"px",top:h+"px","z-index":"400"}),$(".hb_num").filter("#"+m).css({left:f+"px",top:h+"px","z-index":"400"}),$(".hb_icon").filter("#"+m).css({left:f+r+"px",top:h+o+"px","z-index":"400"})}}function load_UI(){var e=game_info.player_list,t=game_info.players;t[user_index];set_rounds();var i=0;$gameSystem.is_audience()||(i+=205);for(var a in e){$("#players").append("<player id='"+a+"'></player>");var s=$("player").filter("#"+a);s.append("<img class='player_back' id='"+a+"' src='"+cdn_url+"/media/img/player_back_"+color_reflection[a]+".png'/>"),s.append("<playername id='"+a+"'>"+e[a][1]+"</playername>"),s.append("<vp_state id='"+a+"'>"+vp_num(a)+"</vp_state>"),s.append("<src_state>"+all_src_num(t[a])+"</src_state>"),s.append("<dev_state>"+all_dev_num(t[a])+"</dev_state>"),s.append("<city0_state>"+city_num(t[a],0)+"</city0_state>"),s.append("<city1_state>"+city_num(t[a],1)+"</city1_state>"),s.append("<longest_road id='"+a+"'></longest_road>"),s.append("<max_minitory id='"+a+"'></max_minitory>"),s.append("<score_card id='"+a+"'></score_card>"),a==user_index?(s.addClass("self"),s.children().addClass("self")):(s.css({top:i+"px"}),i+=158),s.css({color:color_reflection_hex[color_reflection[a]]}),game_info.longest_road==a&&$("longest_road").filter("#"+a).addClass("active"),game_info.max_minitory==a&&$("max_minitory").filter("#"+a).addClass("active"),0!=t[a].score_shown&&$("score_card").filter("#"+a).addClass("active")}for(var n=1;n<1+src_size;n++)$("srcs_selected").append("<src_item num='0' class='"+order[n]+"'></src_item>"),$("srcs_available").append("<src_item num='0' class='"+order[n]+"'></src_item>");for(var n=1;n<7;n++)$("actions2").append("<button trade_target='harbour' target_val='"+n+"' type='button' class='action_prepare_trade list-group-item'>"+order_ch[n]+"港</button>");for(var n=1;n<6;n++)$("actions2").append("<button src_id='"+n+"' type='button' class='src_selector list-group-item'>"+order_ch[n]+"</button>");var r=!0,o=!1,_=void 0;try{for(var c,l=score_cards[Symbol.iterator]();!(r=(c=l.next()).done);r=!0){var d=c.value;$("actions2").append("<button src_id='"+n+"' type='button' class='score_card_selector list-group-item'>"+d+"</button>")}}catch(e){o=!0,_=e}finally{try{!r&&l.return&&l.return()}finally{if(o)throw _}}$("actions2").append("<button trade_target='player' target_val='0' type='button' class='action_prepare_trade list-group-item'>公开交易</button>"),$("special_actions").append("<button trade_target='player' target_val='0' type='button' class='action_prepare_trade list-group-item'>公开交易</button>");for(var a in game_info.player_list)$("actions2").append("<button trade_target='player' target_val='"+a+"' type='button' class='action_prepare_trade list-group-item'>"+game_info.player_list[a][1]+"</button>"),$("special_actions").append("<button trade_target='player' target_val='"+a+"' type='button' class='action_prepare_trade list-group-item'>"+game_info.player_list[a][1]+"</button>");create_trade_items(),$youziku.submit("playername_update")}function set_robber(e){0==$("robber").children().length&&$("robber").append("<img src='"+cdn_url+"/media/img/robber.png' style='position:absolute;'>");var t=parseInt(e/ysize),i=e%ysize,a=(places[e],Math.round(t*edge_size*1.5)+45),s=Math.round(i*edge_size*1.732+t%2*.5*1.732*edge_size);$("robber").children().css({left:a,top:s,"z-index":800})}function add_road(e){var t=parseInt(e/3),i=parseInt(t/ysize),a=t%ysize,s=(places[t],Math.round(i*edge_size*1.5)),n=Math.round(a*edge_size*1.732+i%2*.5*1.732*edge_size);switch(e%3){case 0:0,0;break;case 1:Math.round(.5*edge_size),-6;break;case 2:Math.round(1.5*edge_size),0}road=roads[e],$("#roads").append("<img class='road' id='"+e+"' src='"+cdn_url+"/media/img/road_dir"+e%3+"_"+color_reflection[road.owner]+".png'/>"),$(".road").filter("#"+e).css({left:s+"px",top:n+"px","z-index":"600"})}function add_city(e){var t,i,a=parseInt(e/2),s=parseInt(a/ysize),n=a%ysize,r=(places[a],Math.round(s*edge_size*1.5)),o=Math.round(n*edge_size*1.732+s%2*.5*1.732*edge_size);switch(e%2){case 0:t=Math.round(.5*edge_size)-29,i=-30;break;case 1:t=Math.round(1.5*edge_size)-28,i=-30}city=cities[e],1==city.level&&(t-=10),$("#cities").append("<img class='city' id='"+e+"' src='"+cdn_url+"/media/img/city_lv"+city.level+"_"+color_reflection[city.owner]+".png'/>"),$(".city").filter("#"+e).css({left:r+t+15+"px",top:o+i+10+"px","z-index":"999"})}function create_step_list(){if(!game_UI.hasOwnProperty("step_list_created")){for(var e=game_info.step_list,t=parseInt(game_info.step_list.length/2),i=0,a=-1*t;a<t+1;a++)if($("step_list").append("<steper pos='"+a+"'></steper>"),$("steper").filter(function(){return $(this).attr("pos")==a}).css({left:i}),0==a){var s=$("steper").filter(function(){return $(this).attr("pos")==a});$("timer-container").css({left:s.position().left,top:0}),s.addClass("ownround"),i+=65}else i+=45;$("steper").each(function(){var t=game_info.step_index+parseInt($(this).attr("pos"));t<0&&(t+=game_info.step_list.length),t>game_info.step_list.length-1&&(t-=game_info.step_list.length),t=e[t],t==user_index&&$(this).addClass("self"),$(this).css("color",color_reflection_hex[color_reflection[t]])}),game_UI.step_list_created=!0}}function create_trade_items(){if(!game_UI.hasOwnProperty("trade_items_created")){for(var e=1;e<6;e++){var t=order[e],i=["give","get"],a=["selected","available"];for(var s in i)for(var n in a){var r=$("trade_window src_select_window."+i[s]+" srcs_"+a[n]+" ."+t);if(0==n)var o=new Selected_Trade_item(r,null,t,i[s]),_=o;else{var c=new Available_Trade_item(r,o,t,i[s]);o.rlt_item=c;var _=c}r.attr("id",game_UI.UI_count),game_UI[game_UI.UI_count]=_,game_UI_list.trade_items["_"+i[s]][a[n]].push(game_UI.UI_count),game_UI.UI_count++}}game_UI.trade_items_created=!0}}function set_rounds(){$gameSystem.play_turns<100?$("#rounds").text(("00"+$gameSystem.play_turns).slice(-2)):$("#rounds").text(""+$gameSystem.play_turns)}function cal_longest_road(e){var t=all_roads(e),i=[];for(road_index in t){var a=t[road_index],s=[a];s=dp_search_road(s,e),i.push(s.concat())}var n=0,r=0;for(var o in i)i[o].length>r&&(r=i[o].length,n=o);return null==i[n]?[]:i[n]}function dp_search_road(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,a=e[e.length-1],s=edge_round_edges_with_pt(a,"road_self"),n=[],r=!1;for(var o in s)if((!game_info.cities.hasOwnProperty(o)||game_info.cities[o].owner==t)&&o!=i){var _=s[o];for(edge_index in _){var c=_[edge_index];-1==e.indexOf(c)&&(r=!0,n.push(dp_search_road(e.concat(c),t,o)))}}if(0==r)return e;var l=0,d=0;for(var m in n)n[m].length>d&&(d=n[m].length,l=m);return null==n[l]?[]:n[l]}function available_places(){var e=[];for(var t in map_info.places)t!=game_info.occupying&&e.push(parseInt(t));return e}function available_edges(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return sQuery("edge",$gamePlayers[e].own_roads).union(t).near_points().not(function(e){return $gameCities.hasOwnProperty(e)}).near_edges().union(sQuery("point",$gamePlayers[e].own_cities).near_edges()).not($gamePlayers[e].own_roads).get_list()}function available_points(e){return sQuery("edge",$gamePlayers[e].own_roads).near_points().not(function(e){if($gameCities.hasOwnProperty(e))return!0;var t=!0,i=!1,a=void 0;try{for(var s,n=sQuery("point",e).near_points().get_list()[Symbol.iterator]();!(t=(s=n.next()).done);t=!0){var r=s.value;if($gameCities.hasOwnProperty(r))return!0}}catch(e){i=!0,a=e}finally{try{!t&&n.return&&n.return()}finally{if(i)throw a}}return!1}).get_list()}function available_points_st(e){return sQuery("point",$gameSystem.all_points()).not(function(e){if($gameCities.hasOwnProperty(e))return!0;var t=!0,i=!1,a=void 0;try{for(var s,n=sQuery("point",e).near_points().get_list()[Symbol.iterator]();!(t=(s=n.next()).done);t=!0){var r=s.value;if($gameCities.hasOwnProperty(r))return!0}}catch(e){i=!0,a=e}finally{try{!t&&n.return&&n.return()}finally{if(i)throw a}}return!1}).get_list()}function available_saber_move_points(e,t){var i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return sQuery("edge",$gamePlayers[e].own_roads).near_points().not(function(e){return $gameCities.hasOwnProperty(e)}).not($gameSabers[t].occupying).not(function(e){return!($gameSabers.map.hasOwnProperty(e)&&i&&$gameSabers[t].level>$gameSabers.map[e].level)}).get_list()}function available_merchant_set_points(e){return sQuery("points",e.own_cities).near_places().get_list()}function all_cities(e){var t=[];for(var i in game_info.cities)game_info.cities[i].owner==e&&t.push(i);return t}function plc_near_places(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[0,1,2,3,4,5];e=parseInt(e);var i=!1;if("object"!=(void 0===t?"undefined":_typeof(t))?(i=!0,need=[t]):need=t,isNaN(e))return i?null:[];var a=parseInt(e/ysize),s=e%ysize,n=[];for(r in need)switch(parseInt(need[r])){case 0:n.push(e-1);break;case 1:n.push((a+1)*ysize+s+a%2-1);break;case 2:n.push((a+1)*ysize+s+a%2);break;case 3:n.push(e+1);break;case 4:n.push((a-1)*ysize+s+a%2);break;case 5:n.push((a-1)*ysize+s+a%2-1)}if(i)return n[0];for(var r=0;r<n.length;)0!=map_info.places.hasOwnProperty(n[r])?r++:n.splice(r,1);return n}function plc_round_edges(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[0,1,2,3,4,5];e=parseInt(e);var i=!1;if("object"!=(void 0===t?"undefined":_typeof(t))?(i=!0,need=[t]):need=t,isNaN(e))return i?null:[];var a=(parseInt(e/ysize),ysize,[]);for(s in need)switch(parseInt(need[s])){case 0:a.push(3*e+1);break;case 1:a.push(3*e+2);break;case 2:a.push(3*plc_near_places(e,2));break;case 3:a.push(3*(e+1)+1);break;case 4:a.push(3*plc_near_places(e,4)+2);break;case 5:a.push(3*e)}for(var s=0;s<a.length;)-1!=map_info.edges.indexOf(a[s])?s++:a.splice(s,1);return i?a[0]:a}function plc_round_points(e){var t=parseInt(e/ysize);if(isNaN(e))return[];for(var e=(ysize,parseInt(e)),i=[2*e,2*e+1,2*e+2,2*e+3,2*(e-ysize+t%2)+1,2*(e+ysize+t%2)],a=0;a<i.length;)-1!=map_info.points.indexOf(i[a])?a++:i.splice(a,1);return i}function edge_round_edges(e){var t,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"edge";switch(i){case"edge":t=3;break;case"blank_edge":t=2;break;case"road":t=1;break;case"road_self":t=0}if(e=parseInt(e),isNaN(e))return[];var a,s=parseInt(e/3),n=parseInt(s/ysize),r=s%ysize,o=e%3;a=0==o?[e+1,3*((n-1)*ysize+r+n%2-1)+2,3*((n-1)*ysize+r+n%2)+1,3*((n-1)*ysize+r+n%2)+1]:1==o?[e-1,e+1,3*((n-1)*ysize+r+n%2-1)+2,3*((n+1)*ysize+r+n%2-1)]:[e-1,3*((n+1)*ysize+r+n%2-1),3*((n+1)*ysize+r+n%2),3*((n+1)*ysize+r+n%2)+1];for(var _=0;_<a.length;)-1!=map_info.edges.indexOf(a[_])?_++:a.splice(_,1);if(3==t)return a;var c;for(game_info.roads.hasOwnProperty(e)?c=game_info.roads[e].owner:0==t&&(t=2);_<a.length;){if(game_info.roads.hasOwnProperty(a[_])){if(2==t){a.splice(_,1);continue}if(game_info.roads[a[_]].owner!=c&&0==t){a.splice(_,1);continue}}else if(0==t||1==t){kid_edges.splice(_,1);continue}_++}return a}function edge_round_edges_with_pt(e){var t,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"edge";switch(i){case"edge":t=3;break;case"blank_edge":t=2;break;case"road":t=1;break;case"road_self":t=0}if(e=parseInt(e),isNaN(e))return[];var a,s=parseInt(e/3),n=parseInt(s/ysize),r=s%ysize,o=e%3;a={},0==o?(a[2*s]=[e+1,3*((n-1)*ysize+r+n%2-1)+2],a[2*((n-1)*ysize+r+n%2)+1]=[3*((n-1)*ysize+r+n%2)+1,3*((n-1)*ysize+r+n%2)+2]):1==o?(a[2*s]=[e-1,3*((n-1)*ysize+r+n%2-1)+2],a[2*s+1]=[e+1,3*((n+1)*ysize+r+n%2-1)]):(a[2*s+1]=[e-1,3*((n+1)*ysize+r+n%2-1)],a[2*((n+1)*ysize+r+n%2)]=[3*((n+1)*ysize+r+n%2),3*((n+1)*ysize+r+n%2)+1]);for(var _ in a)for(var c=0,l=a[_];c<l.length;)-1!=map_info.edges.indexOf(l[c])?c++:l.splice(c,1);if(3==t)return a;var d;game_info.roads.hasOwnProperty(e)?d=game_info.roads[e].owner:0==t&&(t=2);for(point_id in a)for(var m=a[point_id],c=0;c<m.length;){if(game_info.roads.hasOwnProperty(m[c])){if(2==t){m.splice(c,1);continue}if(game_info.roads[m[c]].owner!=d&&0==t){m.splice(c,1);continue}}else if(0==t||1==t){m.splice(c,1);continue}c++}return a}function edge_round_points(e){if(e=parseInt(e),isNaN(e))return[];var t,i=parseInt(e/3);switch(e%3){case 0:t=[2*i,2*plc_near_places(i,4)+1];break;case 1:t=[2*i,2*i+1];break;case 2:t=[2*i+1,2*plc_near_places(i,2)]}for(var a=0;a<t.length;)-1!=map_info.points.indexOf(t[a])?a++:t.splice(a,1);return t}function pt_round_places(e){if(e=parseInt(e),isNaN(e))return[];var t,i=parseInt(e/2),a=(parseInt(i/ysize),ysize,e%2);t=0==a?union([i],plc_near_places(i,[0,5])):union([i],plc_near_places(i,[0,1]));for(var s=0;s<t.length;)-1!=map_info.places.hasOwnProperty(t[s])?s++:t.splice(s,1);return t}function pt_round_edges(e){if(e=parseInt(e),isNaN(e))return[];var t,i=parseInt(e/2),a=parseInt(i/ysize),s=i%ysize,n=e%2;t=0==n?[3*i,3*i+1,3*((a-1)*ysize+s-1+a%2)+2]:[3*i+1,3*i+2,3*((a+1)*ysize+s-1+a%2)];for(var r=0;r<t.length;)-1!=map_info.edges.indexOf(t[r])?r++:t.splice(r,1);return t}function pt_round_points(e){if(e=parseInt(e),isNaN(e))return[];var t,i=parseInt(e/2);t=e%2==0?[e+1,2*plc_near_places(i,5)+1,2*plc_near_places(i,4)+1]:[e-1,2*plc_near_places(i,1),2*plc_near_places(i,2)];for(var a=0;a<t.length;)-1!=map_info.points.indexOf(t[a])?a++:t.splice(a,1);return t}function sQuery(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],i=SelectorQuery.prototype.check_input(t),a={},s=[],n=!0,r=!1,o=void 0;try{for(var _,c=i[Symbol.iterator]();!(n=(_=c.next()).done);n=!0){var l=_.value;a.hasOwnProperty(l)||(s.push(l),a[l]=!0)}}catch(e){r=!0,o=e}finally{try{!n&&c.return&&c.return()}finally{if(r)throw o}}return new SelectorQuery(e,s)}function SelectorQuery(e,t){this.type=e,this.id_list=t}function start_trade_window(){var e,t,i,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"bank",s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=[],r=[],o=game_info.players[user_index],_=o,c=game_info.cards,l="",d="你",m=1,p=game_info.trades,u=!0;switch(s=parseInt(s),game_temp.action_now="action_trade",game_temp.trade_target=a,game_temp.trade_basic_give_num=0,game_temp.trade_basic_get_num=0,game_temp.trade_target_value=s,game_temp.action_trade_items_function=trade_items,$("#action_refuse_trade_items").hide(),a){case"bank":game_temp.trade_now_id=0,m=4,e="发起交易",t="与银行交易 4:1",r.push(1,2,3,4,5),n.push(1,2,3,4,5);break;case"harbour":game_temp.trade_now_id=0,game_temp.trade_target="bank",e="发起交易","6"==s?(m=3,n.push(1,2,3,4,5),t="与"+order_ch[s]+"港交易 3:1"):(m=2,n.push(parseInt(s)),t="与"+order_ch[s]+"港交易 2:1"),r.push(1,2,3,4,5);break;case"player":i=0==s||game_info.players[s].src_secret;var f=s*(Object.keys(game_info.players).length+1)+user_index;-1==game_info.active_trades.indexOf(f)?(game_temp.trade_now_id=user_index*(Object.keys(game_info.players).length+1)+s,_=game_info.players[user_index],c=i?unknown_cards:game_info.players[s]):(game_temp.trade_now_id=f,_=i?unknown_cards:game_info.players[s],c=game_info.players[user_index],d="他"),e="发起交易",m=1,n.push(1,2,3,4,5),r.push(1,2,3,4,5),t="0"==s?game_info.players[s].name+" 的公开交易":"与 "+game_info.player_list[s][1]+" 交易"}var h=p[game_temp.trade_now_id];-1==game_info.active_trades.indexOf(game_temp.trade_now_id)?h.clear():h.starter==user_index?(l="等待对方响应...",e="取消交易",game_temp.action_trade_items_function=cancel_trade):(l="请作出回应...",e="接受交易",game_temp.action_trade_items_function=accept_trade,$("#action_refuse_trade_items").show()),game_temp.trade_now=h;for(var g=h.starter_list,v=h.accepter_list,y=game_UI_list.trade_items._give.selected,w=0;w<y.length;w++){var b=y[w],x=game_UI[b],k=src_reflection[x.item_type];x.ratio_num=m,x.own_num=g.hasOwnProperty(k)?g[k]:0,x.jqdom_init()}y=game_UI_list.trade_items._get.selected;for(var w=0;w<y.length;w++){var b=y[w],x=game_UI[b],k=src_reflection[x.item_type];x.ratio_num=1,x.own_num=v.hasOwnProperty(k)?v[k]:0,x.jqdom_init()}y=game_UI_list.trade_items._give.available;for(var w=0;w<y.length;w++){var b=y[w],x=game_UI[b];if(x.secret="player"==game_temp.trade_target&&"他"==d&&i,-1==n.indexOf(src_reflection[x.item_type]))var C=0;else var C=_[x.item_type+"_num"];x.ratio_num=m,x.own_num=C,x.jqdom_init(),x.own_num-=x.rlt_item.own_num,x.jqdom_update()}y=game_UI_list.trade_items._get.available;for(var w=0;w<y.length;w++){var b=y[w],x=game_UI[b];if(x.ratio_num=1,x.secret="player"==game_temp.trade_target&&"你"==d&&i,-1==r.indexOf(src_reflection[x.item_type]))var C=0;else var C=c[x.item_type+"_num"];x.own_num=C,x.jqdom_init(),x.own_num-=x.rlt_item.own_num,x.own_num<0&&(u=!1),x.jqdom_update()}-1==game_info.active_trades.indexOf(game_temp.trade_now_id)?u=!1:$("#action_trade_items").text("取消交易"),u?$("#action_trade_items").removeClass("disabled"):$("#action_trade_items").addClass("disabled"),$("trade_window window_head head_text").text(t),$("trade_window person").text(d),$("#action_trade_items").text(e),$("trade_state").text(l),$("trade_window").show()}function close_trade_window(){$("trade_window").hide(),$(".action_prepare_trade").removeClass("active")}function request_game_info(){$.ajax({async:!1,url:"/ajax/t_create_map/",type:"get",dataType:"json",headers:{"X-CSRFToken":$.cookie("csrftoken")},success:function(e){map_info=e,load_process.map=!0}}),$.ajax({async:!1,url:"/ajax/t_load_game/",type:"get",dataType:"json",headers:{"X-CSRFToken":$.cookie("csrftoken")},success:function(e){game_info=e,load_process.game=!0}});for(var e in load_process)if(0==load_process[e]){alert(e+"加载失败！");for(var t in load_process)load_process[t]=!1;return!1}load_map(),load_UI(),load_game(),init_ui(),offline||ws.sendmsg("mes_member",{change:"ready",value:[user_id]})}function load_game(){user_id=game_info.player_list[user_index][0];for(var e in game_info.players)game_info.players[e]=new Player(game_info.players[e]);for(var t in game_info.trades)game_info.trades[t]=new Transaction(game_info.trades[t]);0==occupying&&(game_info.occupying=map_info.basic_roober)}function init_ui(){$("dice").show(),$("his_window").show(),$("source_list").show(),debug||($("#debuging").hide(),$("#debug_show_ids").hide(),$("#debug_show_selectors").hide()),UI_new_turn(),update_static_Graphic(),game_temp.recive_list=[].concat(game_info.online_list),game_info.game_process}function init_menu_lv(e,t){if(t.hasClass("disabled")||t.hasClass("part_disabled"))return!1;clear_selectors(),hide_special_actions();var i=!1;switch(e){case 0:t.hasClass("active")&&($("actions1").children().not("actions2").hide(),t.removeClass("active"),i=!0),$("actions1").children().not("actions2").removeClass("active").hide(),$("actions0").children().not("actions1").children().removeClass("active");case 1:t.hasClass("active")&&($("actions2").children().hide(),t.removeClass("active"),i=!0),$("actions2").children().removeClass("active").hide(),$("actions1").children().not("actions1").removeClass("active");case 2:t.hasClass("active")&&(t.removeClass("active"),i=!0),$("actions2").children().removeClass("active")}return!i&&void 0}function UI_use_dev_update(){for(var e=game_info.players[user_index],t=-1,i=0;i<4;i++)0!=e[devs[i]+"_num"]?(e.dev_used?$("#action_use_dev_"+devs[i]).attr("tip","本回合已使用发展卡").addClass("part_disabled"):e[devs[i]+"_num"]<=e[devs[i]+"_get_before"]&&$("#action_use_dev_"+devs[i]).attr("tip","本回合获得的发展卡不能使用").addClass("part_disabled"),t+=1):$("#action_use_dev_"+devs[i]).hide();return $gameSystem.self_player().score_unshown.length>0?(t+=1,$("#action_show_score_cards").show()):$("#action_show_score_cards").hide(),$("actions1").css("top",$("#action_develop").position().top-25*t),t}function show_special_actions(){for(var e=arguments.length,t=Array(e),i=0;i<e;i++)t[i]=arguments[i];if("trade"==t[0]){for(var a=1;a<t.length;a++)$("special_actions").children().filter(function(){return parseInt($(this).attr("target_val"))==t[a]}).show();$("special_actions").css({top:100,left:$("actions0").position().left+123})}else{for(var a in t)$("#"+t[a]).show();$("special_actions").css({top:$("actions0").position().top,left:$("actions0").position().left+123})}}function hide_special_actions(){$("special_actions").children().hide()}function UI_begin_turn(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];clear_selectors(),hide_special_actions(),(2!=game_info.game_process||e)&&($("dice").removeClass(),$("actions0").children().children().removeClass("disabled active part_disabled"),game_info.step_list[game_info.step_index]==user_index||offline?UI_start_dice():UI_hide_basic_menu(),set_rounds())}function UI_hide_basic_menu(){$("actions0").hide()}function UI_start_dice(){$("actions0").show(),$("actions0").children().not(".fst_action").hide(),$("actions1").children().not("actions2").hide(),$("actions2").children().hide(),$("special_actions").children().hide()}function UI_set_dices(){
for(var e=arguments.length,t=Array(e),i=0;i<e;i++)t[i]=arguments[i];$("dice").each(function(){$(this).addClass("num"+t[$(this).attr("dice_id")])}),$("actions0").children().filter(".fst_action").children().addClass("disabled")}function UI_start_build(){$gameSystem.is_own_turn()&&1!=game_info.game_process&&$("actions0").children().not(".fst_action").show(),0!=$gameSystem.time_per_turn&&timer.start()}function UI_start_set_home(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;switch(game_temp.action_now="fst_set_home",game_temp.home_step=e,e%2){case 0:var i=available_points_st(user_index);for(var a in i)$("pt_selector").filter("#"+i[a]).addClass("selector_available active").show();break;case 1:var s=pt_round_edges(t);for(var a in s)$("edge_selector").filter("#"+s[a]).addClass("selector_available active").show()}}function create_simple_items(e){var t=null,i=null;switch(e){case"drop":t=Selected_Drop_item,i=Available_Drop_item;break;case"plenty":t=Selected_Plenty_item,i=Available_Plenty_item}game_UI_list[e+"_items"]={selected:[],available:[]};for(var a=1;a<6;a++){var s=order[a],n=$("simple_item_select_window").children().filter("src_select_window").children().filter("srcs_selected").children().filter("."+s),r=new t(n,null,s);r.ratio_num=1,game_UI[game_UI.UI_count]=r,game_UI_list[e+"_items"].selected.push(game_UI.UI_count),game_UI.UI_count++,n=$("simple_item_select_window").children().filter("src_select_window").children().filter("srcs_available").children().filter("."+s);var o=new i(n,r,s);o.ratio_num=1,game_UI[game_UI.UI_count]=o,game_UI_list[e+"_items"].available.push(game_UI.UI_count),game_UI.UI_count++,r.rlt_item=o}}function UI_start_plenty_select(){$("simple_item_select_window").show(),$("#action_confirm_selected_items").addClass("disabled"),$("simple_item_select_window #close").show(),0==game_UI.hasOwnProperty("plenty_items_created")&&(create_simple_items("plenty"),game_UI.plenty_items_created=!0);var e=!0,t=!1,i=void 0;try{for(var a,s=game_UI_list.plenty_items.selected.concat(game_UI_list.plenty_items.available)[Symbol.iterator]();!(e=(a=s.next()).done);e=!0){var n=a.value;game_UI[n].jqdom.attr("id",n)}}catch(e){t=!0,i=e}finally{try{!e&&s.return&&s.return()}finally{if(t)throw i}}for(var r=game_UI_list.plenty_items.selected,o=0;o<r.length;o++){var _=r[o],c=game_UI[_];c.own_num=0,c.jqdom_init()}for(var r=game_UI_list.plenty_items.available,o=0;o<r.length;o++){var _=r[o],c=game_UI[_],l=$gameBank.src(c.item_type);c.own_num=l,c.jqdom_init()}game_temp.plenty_count=0,$("#item_count").text("0"),$("#item_top_limit").text(""+game_temp.item_top_limit),$("simple_item_select_window").children().filter("window_head").children().filter("head_text").text("收获资源"),$("simple_item_select_window").children().filter("src_select_window").children().filter("head_text").children().filter("content").text("可收获资源数"),$("#action_confirm_selected_items").text("收获资源")}function UI_start_drop_select(){$("simple_item_select_window").show(),$("#action_confirm_selected_items").addClass("disabled"),$("simple_item_select_window #close").hide();var e=game_info.players[user_index];0==game_UI.hasOwnProperty("drop_items_created")&&(create_simple_items("drop"),game_UI.drop_items_created=!0);var t=!0,i=!1,a=void 0;try{for(var s,n=game_UI_list.drop_items.selected.concat(game_UI_list.drop_items.available)[Symbol.iterator]();!(t=(s=n.next()).done);t=!0){var r=s.value;game_UI[r].jqdom.attr("id",r)}}catch(e){i=!0,a=e}finally{try{!t&&n.return&&n.return()}finally{if(i)throw a}}for(var o=game_UI_list.drop_items.selected,_=0;_<o.length;_++){var c=o[_],l=game_UI[c];l.own_num=0,l.jqdom_init()}for(var o=game_UI_list.drop_items.available,_=0;_<o.length;_++){var c=o[_],l=game_UI[c],d=e[l.item_type+"_num"];l.own_num=d,l.jqdom_init()}game_temp.dropped=0,$("#item_count").text("0"),$("#item_top_limit").text(""+game_temp.drop_required),$("simple_item_select_window").children().filter("window_head").children().filter("head_text").text("舍弃资源"),$("simple_item_select_window").children().filter("src_select_window").children().filter("head_text").children().filter("content").text("需要舍弃的资源"),$("#action_confirm_selected_items").text("舍弃资源")}function UI_start_robber_set(){var e=available_places();for(var t in e)$("plc_selector").filter("#"+e[t]).addClass("active selector_available").show()}function UI_cancel_menu_active(){switch(game_temp.action_now){case"action_use_dev_plenty":init_menu_lv(1,$("#action_use_dev_plenty"));break;case"action_show_score_cards":init_menu_lv(1,$("#action_show_score_cards"))}}function close_simple_item_select_window(){$("simple_item_select_window").hide(),UI_cancel_menu_active()}function close_confirm_window(){$("confirm_window").hide(),"action_use_dev_road_making"==game_temp.action_now?($("edge_selector").filter("#"+game_temp.selected_edge[1]).removeClass("selector_selected"),game_temp.selected_edge.splice(1,1)):cancel_selectors(),UI_cancel_menu_active()}function dice_sum(){return game_info.dice_num[0]+game_info.dice_num[1]}function all_src_num(e){return"object"!=(void 0===e?"undefined":_typeof(e))&&(e=game_info.players[e]),e.brick_num+e.wood_num+e.wool_num+e.grain_num+e.ore_num}function all_dev_num(e){return e.soldier_num+e.plenty_num+e.monopoly_num+e.road_making_num+e.score_unshown.length}function city_num(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"all",i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"count",a=e.own_cities,s=game_info.cities,n=[];for(var r in a)"all"!=t&&s[a[r]].level!=t||n.push(a[r]);return"count"==i?n.length:"all"==i?n:void 0}function vp_num(e){var t=vp_info(game_info.players[e],e),i=0;for(var a in t)i+=t[a];return i}function vp_info(e,t){var a=arguments.length>2&&void 0!==arguments[2]&&arguments[2],s=[0,0,0,0,0],n=e.own_cities,r=game_info.cities;for(i in n)s[1-r[n[i]].level]+=r[n[i]].level+1;return t==game_info.longest_road&&(s[2]+=2),t==game_info.max_minitory&&(s[3]+=2),s[4]+=a?e.score_shown.length+e.score_unshown.length:e.score_shown.length,s}function all_roads(e){var t=[];for(var i in game_info.roads)game_info.roads[i].owner==e&&t.push(parseInt(i));return t}function all_harbours(e){var t=[],i=game_info.players[e].own_cities;for(var a in i){var s=game_info.cities[i[a]];0!=s.ex_type&&(t=union(t,[s.ex_type]))}return t}function union(e,t){return e.concat(t.filter(function(t){return-1===e.indexOf(t)}))}function load_ws_function_msg(){offline&&(ws.send=function(e){$.get("/ajax/t_virtual_websocket/",e,function(e){ws.onmessage(e)},"json")}),ws.sendmsg=function(e,t){$("wait_window").show();var i={type:e,message:t};offline?this.send("data="+JSON.stringify(i)):this.send(JSON.stringify(i))},ws.onmessage=function(e){var t;t="object"==_typeof(e.data)?e.data:JSON.parse(e.data),handle_msg(t)}}function handle_msg(e){switch(e.type){case"mes_action":var t=e.message.val;switch(t[0]){case 0:set_dice(t[2],t[3]);break;case 1:switch(t[1]){case 1:build_road(t[2],e.message.starter);break;case 2:build_city0(t[2],e.message.starter);break;case 3:build_city1(t[2],e.message.starter);break;case 4:extract_dev_card(t[3],e.message.starter)}break;case 2:switch(t[1]){case 1:case 2:trade_with_bank(t[2],t[3],e.message.starter);break;case 3:give_trade_with_player(t[2]);break;case 4:switch(t[2]){case 1:response_trade_with_player(t[3],e.message.starter);break;case 2:msg_refuse_trade(t[3],e.message.starter);break;case 3:msg_cancel_trade(t[3])}break;case 5:trade_with_player(t[2],t[3])}break;case 3:switch(t[1]){case 1:set_robber_info(t[2],e.message.starter,t[3],t[5],!0);break;case 2:dev_plenty(t[2],e.message.starter);break;case 3:dev_monopoly(t[2],e.message.starter);break;case 4:dev_road_making(t[2],t[3],e.message.starter);break;case 5:show_score_card(t[2],e.message.starter)}break;case 4:set_robber_info(t[1],e.message.starter,t[2],t[4]);break;case 5:drop_srcs(t[1],e.message.starter);break;case 6:new_turn();break;case 8:set_home(t[1],t[2],e.message.starter);break;case 9:fst_dice(t[2],t[3],e.message.starter);break;case 19:new_talk_message(t[1],e.message.starter)}break;case"mes_member":member_handle_msg(e.message)}try{debug_handel_msg(e)}catch(e){}!offline&&$gameSystem.is_room_owner()&&upload_game_info(),update_vp_infos(),update_static_Graphic()}function set_dice(e,t){debug&&(e=3,t=3);$gameSystem.dice_7_step=0,game_info.dice_num[0]=e,game_info.dice_num[1]=t,UI_set_dices(e,t);var i=e+t,a=map_info.places;if(his_window.push("掷出点数: "+i),7==i){$gameSystem.recive_list=[].concat($gameSystem.online_list),$gameSystem.dice_7_step=1;var s=!0,n=!1,r=void 0;try{for(var o,_=Object.values($gamePlayers)[Symbol.iterator]();!(s=(o=_.next()).done);s=!0){var c=o.value;c.all_src_num()>7?c.drop_required=parseInt(c.all_src_num()/2):c.drop_required=0}}catch(e){n=!0,r=e}finally{try{!s&&_.return&&_.return()}finally{if(n)throw r}}return void start_drop_select()}for(var l in a){var d=a[l];if(d.create_num==i){if(game_info.occupying==l){his_window.push("地块被占据,无法产出");continue}var m=plc_round_points(l);for(var p in m){var u=m[p];if(game_info.cities.hasOwnProperty(u)){var f,h=game_info.cities[u],g=game_info.players[h.owner];f=0==h.level?1:2,g[order[d.create_type]+"_num"]+=f,his_window.push(game_info.player_list[h.owner][1]+"获得 "+order_ch[d.create_type]+" x "+f)}}}}UI_start_build()}function start_drop_select(){$gameSystem.self_player().drop_required>0?(game_temp.drop_required=$gameSystem.self_player().drop_required,his_window.push("你需要丢弃 "+game_temp.drop_required+" 份资源"),game_temp.action_base="action_drop_srcs_for_7",game_temp.action_now="action_drop_srcs_for_7",can_start_build=!1,UI_start_drop_select(),$("wait_window").hide()):ws.sendmsg("mes_action",{starter:user_index,val:[5,{}]})}function build_road(e,t){var i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];clear_selectors(),$("#action_build_road").removeClass("active");var a=game_info.players[t];i&&(a.brick_num--,a.wood_num--),game_info.roads[e]=new Road(t),a.own_roads.push(e),his_window.push(game_info.player_list[t][1]+" 建造了一条道路"),add_road(e)}function build_city0(e,t){var i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];clear_selectors(),$("#action_build_city0").removeClass("active");var a=game_info.players[t];i&&(a.brick_num--,a.wood_num--,a.wool_num--,a.grain_num--);var s=0;for(var n in map_info.harbors){var r=map_info.harbors[n];-1!=edge_round_points(plc_round_edges(r.place_id,dir_reflection[r.direct])).indexOf(e)&&(s=r.ex_type)}game_info.cities[e]=new City(t,s),game_info.players[t].own_cities.push(e),his_window.push(game_info.player_list[t][1]+" 建立了一个新定居点"),add_city(e)}function build_city1(e,t){clear_selectors(),$("#action_build_city1").removeClass("active");var i=game_info.players[t];i.grain_num-=2,i.ore_num-=3,game_info.cities[e].level=1,his_window.push(game_info.player_list[t][1]+" 建成了一座新城市")}function extract_dev_card(e,t){$("#action_buy_dev_card").removeClass("active");var i=game_info.cards,a=game_info.players[t];return a.grain_num-=1,a.wool_num-=1,a.ore_num-=1,his_window.push(game_info.player_list[t][1]+" 抽取了一张发展卡"),e<i.soldier_num?(user_index==t&&his_window.push("(你获得了士兵卡)"),i.soldier_num--,a.soldier_num++,void a.soldier_get_before++):(e-=i.soldier_num)<i.plenty_num?(user_index==t&&his_window.push("(你获得了丰收卡)"),i.plenty_num--,a.plenty_num++,void a.plenty_get_before++):(e-=i.plenty_num)<i.monopoly_num?(user_index==t&&his_window.push("(你获得了垄断卡)"),i.monopoly_num--,a.monopoly_num++,void a.monopoly_get_before++):(e-=i.monopoly_num)<i.road_making_num?(user_index==t&&his_window.push("(你获得了修路卡)"),i.road_making_num--,a.road_making_num++,void a.road_making_get_before++):(e-=i.road_making_num,e<i.score_cards.length?(user_index==t&&his_window.push("(你获得了分数卡:"+i.score_cards[e]+")"),a.score_unshown.push(i.score_cards[e]),void i.score_cards.splice(e,1)):void 0)}function trade_with_bank(e,t,i){close_trade_window();var a=game_info.players[i],s=game_info.cards;game_info.active_trades.splice(game_info.active_trades.indexOf(0),1);for(var n in e){var r=order[n]+"_num";a[r]-=e[n],s[r]+=e[n],his_window.push(game_info.player_list[i][1]+" 给了银行 "+order_ch[n]+" x "+e[n])}for(var n in t){var r=order[n]+"_num";a[r]+=t[n],s[r]-=t[n],his_window.push("银行给了 "+game_info.player_list[i][1]+" "+order_ch[n]+" x "+t[n])}}function give_trade_with_player(e){e.starter!=user_index&&(game_info.trades[e.id].refresh(e),game_info.active_trades.push(e.id),e.accepter==user_index?(his_window.push(game_info.player_list[e.starter][1]+" 想要与你交易","important"),show_special_actions("trade",e.starter)):0==e.accepter&&(his_window.push(game_info.player_list[e.starter][1]+" 发起了公开交易","important"),show_special_actions("trade","0"))),offline&&0!=e.accepter&&ws.sendmsg("mes_action",{starter:e.accepter,accepter:e.starter,val:[2,4,1,e.id]})}function msg_refuse_trade(e,t){if(-1!=game_info.active_trades.indexOf(e)){var i=game_info.trades[e];i.trade_state="refused",game_info.active_trades.splice(game_info.active_trades.indexOf(i.id),1),window_finish_trade(i,t)}}function msg_cancel_trade(e){if(-1!=game_info.active_trades.indexOf(e)){var t=game_info.trades[e];t.starter!=user_index&&(t.trade_state="canceled",game_info.active_trades.splice(game_info.active_trades.indexOf(t.id),1),window_finish_trade(t))}}function response_trade_with_player(e,t){var i=game_info.trades[e];"requesting"==i.trade_state&&(i.trade_state="success",i.final_accepter=t,ws.sendmsg("mes_action",{val:[2,5,e,t]}))}function trade_with_player(e,t){var i=game_info.trades[e];i.final_accepter=t,i.trade_state="success",game_info.active_trades.splice(game_info.active_trades.indexOf(e),1);var a=game_info.players[i.starter],s=game_info.players[i.final_accepter],n=game_info.player_list;for(var r in i.starter_list){var o=order[r]+"_num",_=i.starter_list[r];a[o]-=_,s[o]+=_,his_window.push(n[i.starter][1]+" 给了 "+n[i.final_accepter][1]+" "+order_ch[r]+" x "+_)}for(var r in i.accepter_list){var o=order[r]+"_num",_=i.accepter_list[r];a[o]+=_,s[o]-=_,his_window.push(n[i.final_accepter][1]+" 给了 "+n[i.starter][1]+" "+order_ch[r]+" x "+_)}window_finish_trade(i)}function set_robber_info(e,t,i,a){var s=arguments.length>4&&void 0!==arguments[4]&&arguments[4];clear_selectors(),$("#action_use_dev_soldier").removeClass("active"),$("#cancel_robbing").hide(),$("#to_before_action").hide(),s||($gameSystem.dice_7_step=0,UI_start_build()),s&&(game_info.players[t].soldier_num--,game_info.players[t].soldier_used++,$gamePlayers[t].dev_used=!0,init_menu_lv(1,$("#action_use_dev_soldier")),UI_use_dev_update()),game_info.occupying=e;var n=map_info.places[e];his_window.push("强盗被放置在数字为 "+n.create_num+" 的 "+order_ch[n.create_type]+" 地块上"),rob_player(t,i,a),game_temp.action_now=""}function rob_player(e,t,i){if(0!=t)for(var a=game_info.player_list,s=game_info.players[t],n=i,r=1;n>=0;r++){if(n<s[order[r]+"_num"]){s[order[r]+"_num"]--,game_info.players[e][order[r]+"_num"]++,his_window.push(a[e][1]+" 掠夺了 "+a[t][1]+" 的一份 "+order_ch[r]);break}n-=s[order[r]+"_num"]}}function drop_srcs(e,t){var i=game_info.players[t];for(var a in e)i[order[a]+"_num"]-=e[a],his_window.push(game_info.player_list[t][1]+" 丢弃了 "+order_ch[a]+" x "+e[a]);if($gamePlayers[t].drop_required=0,t==user_index&&$("simple_item_select_window").hide(),1==$gameSystem.msg_recive(t)){$gameSystem.dice_7_step=2;var s=!0,n=!1,r=void 0;try{for(var o,_=Object.values($gamePlayers)[Symbol.iterator]();!(s=(o=_.next()).done);s=!0){o.value.drop_required=0}}catch(e){n=!0,r=e}finally{try{!s&&_.return&&_.return()}finally{if(n)throw r}}$("wait_window").hide(),$gameSystem.is_own_turn()?start_robber_set():his_window.push("由 "+game_info.player_list[game_info.step_list[game_info.step_index]][1]+" 设置强盗")}else game_info.step_list[game_info.step_index]==user_index&&t==user_index&&(his_window.push("等待其他玩家选择丢弃资源..."),$("wait_window").show())}function start_robber_set(){his_window.push("由你设置强盗:"),game_temp.action_base="action_set_robber_for_7",game_temp.action_now="action_set_robber_for_7",UI_start_robber_set()}function dev_plenty(e,t){var i=$gamePlayers[t];i.dev_used=!0,his_window.push(i.name+" 使用了 丰收卡");for(var a in e)i.src(a,"+=",e[a]);i.dev("plenty","-=",1),close_simple_item_select_window(),init_menu_lv(1,$("#action_use_dev_plenty")),UI_use_dev_update()}function dev_monopoly(e,t){var i=game_info.players[t];i.dev_used=!0,i.no_build_dev_used=!0,his_window.push(i.name+" 使用了 垄断卡"),i.dev("monopoly","-=",1);for(var a in game_info.players)if(t!=a){var s=game_info.players[a];i.src(e,"+=",s.src(e),!1),his_window.push(s.name+" 交出了 "+s.src(e)+" 份 "+order_ch[e]),s.src(e,0,!1)}init_menu_lv(1,$("#action_use_dev_monopoly")),UI_use_dev_update()}function dev_road_making(e,t,i){var a=game_info.players[i];a.dev_used=!0,a.dev("road_making","-=",1),his_window.push(a.name+" 使用了 道路建设卡"),build_road(e,i,!1),build_road(t,i,!1),init_menu_lv(1,$("#action_use_dev_road_making")),UI_use_dev_update()}function show_score_card(e,t){var i=$gamePlayers[t];i.show_score_cards([e]),his_window.push(i.name+" 展示了分数卡 "+e),init_menu_lv(1,$("#action_show_score_cards")),UI_use_dev_update()}function new_turn(){if(game_info.step_list==[])return void alert("出现死循环!");timer.stop(),close_trade_window(),last_step_index=game_info.step_index;for(var e,t=game_info.step_index+1;;){if(t==Object.keys(game_info.player_list).length&&(t=0),e=game_info.step_list[t],-1!=game_info.online_list.indexOf(e))break;t++}game_info.step_index=t,game_info.dice_num=[0,0],3==game_info.game_process&&game_info.play_turns++,$gameSystem.recive_list=[].concat(game_info.online_list);for(e in $gamePlayers)for(var i=$gamePlayers[e],a=0;a<4;a++)i[devs[a]+"_get_before"]=0,i.dev_used=!1,i.no_build_dev_used=!1;game_info.active_trades.length=0,offline&&(user_index=game_info.step_list[game_info.step_index]),turn_rounds(),his_window.push("----------回合结束----------"),his_window.push("第 "+game_info.play_turns+" 回合,轮到 "+game_info.player_list[game_info.step_list[game_info.step_index]][1]+" 行动"),UI_begin_turn()}function set_home(e,t,a){var s=game_info.players[a];switch(s.home_step=e+1,e%2){case 0:if(build_city0(t,a,!1),e>1){var n=pt_round_places(t);for(i in n){var r=map_info.places[n[i]];null!=r&&s.src(r.create_type,"+=",1)}}his_window.push("由 "+s.name+" 建设道路"),a==user_index&&UI_start_set_home(s.home_step,t);break;case 1:build_road(t,a,!1),game_info.step_index==game_info.step_list.length-1&&(game_info.step_list.reverse(),e>2&&(!offline||e>4*Object.keys(game_info.player_list).length-2)&&(game_info.game_process=3)),new_turn(),$gameSystem.is_own_turn()&&3!=game_info.game_process&&UI_start_set_home($gameSystem.active_player().home_step)}}function fst_dice(e,t,i){var a=game_info.players[i];a.first_dice[0]=e,a.first_dice[1]=t,user_index==i&&UI_set_dices(e,t);var s=e+t;his_window.push(a.name+" 掷出点数: "+e+","+t+" ,共计 "+s,"important");var n=[];if($gameSystem.msg_recive(i)){var r=[0];for(var o in $gamePlayers)r[o]=$gamePlayers[o].first_dice[0]+$gamePlayers[o].first_dice[1];for(var _=0;Object.keys(r).length>1;){var c=0;for(var l in r)r[l]>r[c]&&(c=l);if(n.push(parseInt(c)),delete r[c],++_>100)return void alert("循环次数过多!")}game_info.step_list=n,game_info.step_index=-1,game_info.game_process=2;var d="";for(var m in $gameSystem.step_list)d+=$gamePlayers[$gameSystem.step_list[m]].name,m!=$gameSystem.step_list.length-1&&(d+="->");his_window.push("行动顺序为:"+d,"important"),his_window.push("----开始安放前期定居点----"),create_step_list(),new_turn(),$gameSystem.is_own_turn()&&UI_start_set_home(0)}}function new_talk_message(e,t){his_window.push($gamePlayers[t].name+"："+e,"important"),user_index==t&&$("#talk_msg_input_window").val("")}function update_vp_infos(){var e=game_info.players,t=game_info.player_list,i=0;for(var a in game_info.player_list){var s=game_info.players[a];s.road_longest=cal_longest_road(a),i=Math.max(s.road_longest.length,i)}i<5&&(i=5),0!=game_info.longest_road&&game_info.players[game_info.longest_road].road_longest.length<i&&(his_window.push(game_info.player_list[game_info.longest_road][1]+" 不再是 最长道路 的修建者。"),game_info.longest_road=0);var n=[];for(var a in game_info.player_list){var s=game_info.players[a];s.road_longest.length==i&&n.push(a)}if(1==n.length&&0==game_info.longest_road&&(his_window.push(game_info.player_list[n[0]][1]+"成为 最长道路 的修建者！"),game_info.longest_road=n[0]),0==game_info.max_minitory)var r=2;else var r=e[game_info.max_minitory].soldier_used;for(var a in e)e[a].soldier_used>r&&(0==game_info.max_minitory?his_window.push(t[a][1]+"成为了 最大军队 的建立者！"):his_window.push(t[a][1]+" 取代 "+t[game_info.max_minitory][1]+"成为了 最大军队 的建立者！"),game_info.max_minitory=a);for(var a in e){var s=e[a];s.vp_update(!0)>=10&&s.index==game_info.step_list[game_info.step_index]&&(s.show_score_cards(),his_window.push(s.name+"取得了胜利！","important"))}}function Road(e){this.owner=e}function City(e,t){this.ex_type=t,this.level=0,this.owner=e}var _get=function e(t,i,a){null===t&&(t=Function.prototype);var s=Object.getOwnPropertyDescriptor(t,i);if(void 0===s){var n=Object.getPrototypeOf(t);return null===n?void 0:e(n,i,a)}if("value"in s)return s.value;var r=s.get;if(void 0!==r)return r.call(a)},_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var a=t[i];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,i,a){return i&&e(t.prototype,i),a&&e(t,a),t}}(),Game_Bank=function(){function e(t){_classCallCheck(this,e);var i=!0,a=!1,s=void 0;try{for(var n,r=Object.keys(t)[Symbol.iterator]();!(i=(n=r.next()).done);i=!0){var o=n.value;this[o]=t[o]}}catch(e){a=!0,s=e}finally{try{!i&&r.return&&r.return()}finally{if(a)throw s}}}return _createClass(e,[{key:"src",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"null",i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"null";if(/^[0-9]+$/.test(e)){e=order[e]}else{src_reflection[e]}if("number"==typeof t&&(i=t,t="="),"null"==i)return this[e+"_num"];switch(t){case"null":case"=":this[e+"_num"]=i;break;case"+=":this[e+"_num"]+=i;break;case"-=":this[e+"_num"]-=i}return this[e+"_num"]}}]),e}();debug=!1,offline=!1,test_model=!1,use_cdn=!0,test_model?websocket_url="ws://192.168.50.140:80/ws/game_test":websocket_url="ws://122.51.21.190:80/ws/game_test",use_cdn?cdn_url="http://cdn.newcenturyfans.cn":cdn_url="",map_info={},game_info={},places={},edge_size=67,xsize=0,ysize=0,last_step_index=0,src_size=5,game_temp={home_step:0,action_now:"",set_option:"",recive_list:[],dev_used:!1,no_build_dev_used:!1,fst_dices:{0:0}},game_UI={UI_count:0},game_UI_list={drop_items:{selected:[],available:[]},trade_items:{_give:{selected:[],available:[]},_get:{selected:[],available:[]}}},user_id=1,user_index=1,load_process={map:!1,game:!1},devs=["soldier","plenty","monopoly","road_making"],order={0:"desert",1:"brick",2:"wood",3:"wool",4:"grain",5:"ore",6:"any_type"},order_ch={0:"沙漠",1:"砖块",2:"木材",3:"羊毛",4:"粮食",5:"铁矿",6:"任意"},src_reflection={desert:0,brick:1,wood:2,wool:3,grain:4,ore:5},color_reflection={1:"light-blue",2:"dark-green",3:"light-orange",4:"light-red",5:"light-purple",6:"light-green"},color_reflection_hex={"light-blue":"#029ed9","dark-green":"#006602","light-orange":"#ff9b38","light-red":"#ff3738","light-purple":"#a3159a","light-green":"#81ff38"},dir_reflection={up:0,ru:1,rd:2,dn:3,ld:4,lu:5},unknown_cards={brick_num:99,wood_num:99,wool_num:99,grain_num:99,ore_num:99},score_cards=["阿尔忒弥斯神庙","牛津大学","巴拿马运河","紫禁城","圣瓦西里大教堂"],vp_info_text=["拥有的城市：","拥有的定居点：","最长道路：","最大军队：","拥有的奇观："];var $gameSystem=null,$gamePlayers=null,$gameCities=null,$gameRoads=null,$gameTrades=null,$gameBank=null;DataManager.load_old_data=function(){game_info=$gameSystem,game_info.players=$gamePlayers,game_info.cities=$gameCities,game_info.roads=$gameRoads,game_info.trades=$gameTrades,game_info.cards=$gameBank},DataManager.applyObject=function(){for(var e in $gamePlayers)$gamePlayers[e]=new Game_Player($gamePlayers[e]);for(var t in $gameTrades)$gameTrades[t]=new Transaction($gameTrades[t]);$gameBank=new Game_Bank($gameBank),$gameSystem=new Game_System($gameSystem)},DataManager.extractSaveContents=function(e){$gameSystem=e.system,$gamePlayers=e.players,$gameCities=e.cities,$gameRoads=e.roads,$gameTrades=e.trades,$gameBank=e.bank,this.applyObject(),this.load_old_data()},DataManager.makeSaveContents=function(){var e={};return e.system=$gameSystem,e.players=$gamePlayers,e.cities=$gameCities,e.roads=$gameRoads,e.trades=$gameTrades,e.bank=$gameBank,e},ready_list={},$(document).ready(function(){$("#type_create_room").change(function(){"on"==$(this).val()&&($("#cmd_join_room").hide(),$("#cmd_create_room").show())}),$("#type_join_room").change(function(){"on"==$(this).val()&&($("#cmd_join_room").show(),$("#cmd_create_room").hide())}),$("#load_game").click(function(){load_ws_function_msg(),request_game_info()}),$("#load_game_online").click(function(){if(user_index=parseInt($("#set_user_index").val()),user_name=$("#set_user_name").val(),room_pswd=$("#room_pswd").val(),offline)return console.log("将以离线模式加载游戏，不会保存游戏数据"),void load_game_offline();init_webscoket(function(){0==user_index?ws.sendmsg("mes_member",{change:"audience_join",value:[user_name]}):ws.sendmsg("mes_member",{change:"relink",value:[user_index]}),request_t_game_info()})}),$("#create_game_online").click(function(){var e=parseInt($("#room_size").val()),t=$("#room_pswd").val(),i=parseInt($("#room_time_per_turn").val()),a=$("#map_template").val();$.ajax({async:!1,url:"/ajax/t_create_room/",type:"get",data:{room_pswd:t,room_size:e,time_per_turn:i,map_template:a},headers:{"X-CSRFToken":$.cookie("csrftoken")},success:function(e){alert(e)}})}),$("#debug_show_selectors").click(function(){"off"==$(this).attr("on")?($(this).attr("on","on"),$("plc_selector").addClass("active selector_available").show(),$("edge_selector").addClass("active selector_available").show(),$("pt_selector").addClass("active selector_available").show()):($(this).attr("on","off"),$("plc_selector").removeClass("active selector_available").hide(),$("edge_selector").removeClass("active selector_available").hide(),$("pt_selector").removeClass("active selector_available").hide())}),$("#debug_show_ids").click(function(){"off"==$(this).attr("on")?($(this).attr("on","on"),$("plc_selector").each(function(){$(this).attr("tip",$(this).attr("id"))}),$("edge_selector").each(function(){$(this).attr("tip",$(this).attr("id"))}),$("pt_selector").each(function(){$(this).attr("tip",$(this).attr("id"))})):($(this).attr("on","off"),$("plc_selector").text(""),$("edge_selector").text(""),$("pt_selector").text(""))})}),SelectorQuery.prototype.get_list=function(){return this.id_list},SelectorQuery.prototype.check_input=function(e){return"number"==typeof e?[e]:e instanceof SelectorQuery?e.get_list():e},SelectorQuery.prototype.union=function(e){var t=this.check_input(e);return this.id_list=this.id_list.concat(t.filter(function(e){return-1===this.id_list.indexOf(e)},this)),this},SelectorQuery.prototype.filter=function(e){if("function"==typeof e)this.id_list=this.id_list.filter(function(t){return e(t)});else{var t=this.check_input(e);this.id_list=this.id_list.filter(function(e){return-1!=t.indexOf(e)})}return this},SelectorQuery.prototype.not=function(e){if("function"==typeof e)this.id_list=this.id_list.filter(function(t){return!e.call(this,t)},this);else{var t=this.check_input(e);this.id_list=this.id_list.filter(function(e){return-1==t.indexOf(e)})}return this},SelectorQuery.prototype.near_places=function(){var e=[];switch(this.type){case"place":var t=!0,i=!1,a=void 0;try{for(var s,n=this.id_list[Symbol.iterator]();!(t=(s=n.next()).done);t=!0){e=union(e,plc_near_places(s.value))}}catch(e){i=!0,a=e}finally{try{!t&&n.return&&n.return()}finally{if(i)throw a}}break;case"edge":var r=!0,o=!1,_=void 0;try{for(var c,l=this.id_list[Symbol.iterator]();!(r=(c=l.next()).done);r=!0){var d=c.value;e=union(e,edge_round_places(d))}}catch(e){o=!0,_=e}finally{try{!r&&l.return&&l.return()}finally{if(o)throw _}}break;case"point":var m=!0,p=!1,u=void 0;try{for(var f,h=this.id_list[Symbol.iterator]();!(m=(f=h.next()).done);m=!0){e=union(e,pt_round_places(f.value))}}catch(e){p=!0,u=e}finally{try{!m&&h.return&&h.return()}finally{if(p)throw u}}}return this.type="place",this.id_list=e,this},SelectorQuery.prototype.near_edges=function(){var e=[];switch(this.type){case"place":var t=!0,i=!1,a=void 0;try{for(var s,n=this.id_list[Symbol.iterator]();!(t=(s=n.next()).done);t=!0){e=union(e,plc_round_edges(s.value))}}catch(e){i=!0,a=e}finally{try{!t&&n.return&&n.return()}finally{if(i)throw a}}break;case"edge":var r=!0,o=!1,_=void 0;try{for(var c,l=this.id_list[Symbol.iterator]();!(r=(c=l.next()).done);r=!0){e=union(e,edge_round_edges(c.value))}}catch(e){o=!0,_=e}finally{try{!r&&l.return&&l.return()}finally{if(o)throw _}}break;case"point":var d=!0,m=!1,p=void 0;try{for(var u,f=this.id_list[Symbol.iterator]();!(d=(u=f.next()).done);d=!0){e=union(e,pt_round_edges(u.value))}}catch(e){m=!0,p=e}finally{try{!d&&f.return&&f.return()}finally{if(m)throw p}}}return this.type="edge",this.id_list=e,this},SelectorQuery.prototype.near_points=function(){var e=[];switch(this.type){case"place":var t=!0,i=!1,a=void 0;try{for(var s,n=this.id_list[Symbol.iterator]();!(t=(s=n.next()).done);t=!0){e=union(e,plc_round_points(s.value))}}catch(e){i=!0,a=e}finally{try{!t&&n.return&&n.return()}finally{if(i)throw a}}break;case"edge":var r=!0,o=!1,_=void 0;try{for(var c,l=this.id_list[Symbol.iterator]();!(r=(c=l.next()).done);r=!0){e=union(e,edge_round_points(c.value))}}catch(e){o=!0,_=e}finally{try{!r&&l.return&&l.return()}finally{if(o)throw _}}break;case"point":var d=!0,m=!1,p=void 0;try{for(var u,f=this.id_list[Symbol.iterator]();!(d=(u=f.next()).done);d=!0){e=union(e,pt_round_points(u.value))}}catch(e){m=!0,p=e}finally{try{!d&&f.return&&f.return()}finally{if(m)throw p}}}return this.type="point",this.id_list=e,this};var Game_Player=function(){function e(t){_classCallCheck(this,e);var i=!0,a=!1,s=void 0;try{for(var n,r=Object.keys(t)[Symbol.iterator]();!(i=(n=r.next()).done);i=!0){var o=n.value;this[o]=t[o]}}catch(e){a=!0,s=e}finally{try{!i&&r.return&&r.return()}finally{if(a)throw s}}this.name=$gameSystem.player_list[this.index][1],this.vp_update()}return _createClass(e,[{key:"src",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"null",i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"null",a=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],s=null;if(/^[0-9]+$/.test(e)?(s=e,e=order[e]):s=src_reflection[e],"number"==typeof t&&(i=t,t="="),"null"==i)return this[e+"_num"];var n=0;switch(t){case"null":case"=":n=i-this[e+"_num"],a&&his_window.player_get_item(this,s,n),this[e+"_num"]=i;break;case"+=":this[e+"_num"]+=i,a&&his_window.player_get_item(this,s,i);break;case"-=":this[e+"_num"]-=i,a&&his_window.player_get_item(this,s,i)}return this[e+"_num"]}},{key:"all_src_num",value:function(){return this.src("brick")+this.src("wood")+this.src("wool")+this.src("grain")+this.src("ore")}},{key:"dev",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"null",i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"null";if("number"==typeof t&&(i=t,t="="),"null"==i)return this[e+"_num"];switch(t){case"null":case"=":this[e+"_num"]=i;break;case"+=":this[e+"_num"]+=i;break;case"-=":this[e+"_num"]-=i}return this[e+"_num"]}},{key:"vp_update",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=[0,0,0,0,0],i=!0,a=!1,s=void 0;try{for(var n,r=this.own_cities[Symbol.iterator]();!(i=(n=r.next()).done);i=!0){var o=n.value;t[1-$gameCities[o].level]+=$gameCities[o].level+1}}catch(e){a=!0,s=e}finally{try{!i&&r.return&&r.return()}finally{if(a)throw s}}this.index==$gameSystem.longest_road&&(t[2]+=2),this.index==$gameSystem.max_minitory&&(t[3]+=2),t[4]+=e?this.score_shown.length+this.score_unshown.length:this.score_shown.length;var _=0;for(var c in t)_+=t[c];return this.vp=_,this.vp}},{key:"show_score_cards",value:function(){
var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"all";if("all"==e)this.score_shown=this.score_shown.concat(this.score_unshown),this.score_unshown.length=0;else{this.score_shown=this.score_shown.concat(e);var t=!0,i=!1,a=void 0;try{for(var s,n=e[Symbol.iterator]();!(t=(s=n.next()).done);t=!0){var r=s.value;this.score_unshown.splice(this.score_unshown.indexOf(r))}}catch(e){i=!0,a=e}finally{try{!t&&n.return&&n.return()}finally{if(i)throw a}}}}},{key:"city_num",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"all",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"count",i=[],a=!0,s=!1,n=void 0;try{for(var r,o=this.own_cities[Symbol.iterator]();!(a=(r=o.next()).done);a=!0){var _=r.value;"all"!=e&&$gameCities[_].level!=e||i.push(_)}}catch(e){s=!0,n=e}finally{try{!a&&o.return&&o.return()}finally{if(s)throw n}}return"count"==t?i.length:"all"==t?i:void 0}}]),e}(),Game_System=function(){function e(t){_classCallCheck(this,e);var i=!0,a=!1,s=void 0;try{for(var n,r=Object.keys(t)[Symbol.iterator]();!(i=(n=r.next()).done);i=!0){var o=n.value;this[o]=t[o]}}catch(e){a=!0,s=e}finally{try{!i&&r.return&&r.return()}finally{if(a)throw s}}}return _createClass(e,[{key:"is_own_turn",value:function(){return!this.is_audience()&&user_index==this.step_list[this.step_index]}},{key:"is_audience",value:function(){return 0==user_index}},{key:"is_room_owner",value:function(){return 1==user_index}},{key:"self_player",value:function(){return $gamePlayers[user_index]}},{key:"active_player",value:function(){return $gamePlayers[this.step_list[this.step_index]]}},{key:"all_cities",value:function(){return Object.keys($gameCities).map(Number)}},{key:"all_roads",value:function(){return Object.keys($gameRoads).map(Number)}},{key:"all_points",value:function(){return map_info.points}},{key:"all_edges",value:function(){return map_info.edges}},{key:"all_palces",value:function(){return Object.keys(map_info.places).map(Number)}},{key:"msg_recive",value:function(e){var t=this.recive_list.indexOf(e);return-1!=t&&this.recive_list.splice(t,1),0==this.recive_list.length||offline}}]),e}(),Transaction=function(){function e(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};_classCallCheck(this,e),"object"==(void 0===t?"undefined":_typeof(t))?(this.id=t.id,this.starter=t.starter,this.accepter=t.accepter,this.trade_state=t.trade_state,this.starter_list=t.starter_list,this.accepter_list=t.accepter_list):(this.id=t,this.starter=i,this.accepter=a,this.trade_state="prepare",this.starter_list=s,this.accepter_list=n)}return _createClass(e,[{key:"refresh",value:function(e){this.trade_state=e.trade_state,this.starter_list=e.starter_list,this.accepter_list=e.accepter_list}},{key:"reload",value:function(e){this.starter_list=e.starter_list,this.accepter_list=e.accepter_list}},{key:"clear",value:function(){this.trade_state="prepare",this.starter_list={},this.accepter_list={}}},{key:"item_refresh",value:function(){this.starter_list={},this.accepter_list={};var e=game_UI_list.trade_items._give.selected,t=game_UI_list.trade_items._get.selected;for(var i in e){var a=e[i],s=game_UI[a];0!=s.own_num&&(this.starter_list[src_reflection[s.item_type]]=s.own_num)}for(var i in t){var a=t[i],s=game_UI[a];0!=s.own_num&&(this.accepter_list[src_reflection[s.item_type]]=s.own_num)}}}]),e}();trade_items=function(){$("trade_state").text("等待对方响应..."),$("#action_trade_items").text("取消交易"),game_temp.action_trade_items_function=cancel_trade;var e=game_UI_list.trade_items._give.selected,t=game_UI_list.trade_items._get.selected;for(var i in e){var a=e[i],s=game_UI[a];0!=s.own_num&&(game_temp.trade_now.starter_list[src_reflection[s.item_type]]=s.own_num)}for(var i in t){var a=t[i],s=game_UI[a];0!=s.own_num&&(game_temp.trade_now.accepter_list[src_reflection[s.item_type]]=s.own_num)}switch(game_temp.trade_now.trade_state="requesting",game_info.active_trades.push(game_temp.trade_now.id),game_temp.trade_target){case"bank":ws.sendmsg("mes_action",{starter:user_index,val:[2,1,game_temp.trade_now.starter_list,game_temp.trade_now.accepter_list]});break;case"player":ws.sendmsg("mes_action",{val:[2,3,game_temp.trade_now]})}0!=game_temp.trade_now_id&&$("wait_window").hide()},accept_trade=function(){var e=game_temp.trade_now;ws.sendmsg("mes_action",{starter:e.accepter,accepter:e.starter,val:[2,4,1,e.id]})},refuse_trade=function(){var e=game_temp.trade_now;ws.sendmsg("mes_action",{starter:e.accepter,val:[2,4,2,e.id]})},cancel_trade=function(){if(-1!=game_info.active_trades.indexOf(game_temp.trade_now_id)){var e=game_temp.trade_now;e.trade_state="canceled",game_info.active_trades.splice(game_info.active_trades.indexOf(e.id),1),window_finish_trade(e),ws.sendmsg("mes_action",{val:[2,4,3,e.id]})}},window_finish_trade=function(e){var t,i=(arguments.length>1&&void 0!==arguments[1]?arguments[1]:user_index,e.starter!=user_index&&e.final_accepter!=user_index);switch(e.trade_state){case"success":i?his_window.push(game_info.player_list[e.starter][1]+" 与 "+game_info.player_list[e.accepter][1]+" 达成了交易！","important"):(t=e.final_accepter==user_index?"你":game_info.player_list[e.final_accepter][1],his_window.push(t+" 接受了交易!","important"));break;case"refused":if(i&&0!=e.accepter)break;t=e.accepter==user_index?"你":game_info.player_list[e.accepter][1],his_window.push(t+" 拒绝了交易!","important");break;case"canceled":if(i&&0!=e.accepter)break;t=e.starter==user_index?"你":game_info.player_list[e.starter][1],his_window.push("交易被 "+t+" 取消!","important")}if(game_temp.trade_now_id==e.id&&(0!=e.accepter||"refused"!=e.trade_state)){switch(e.trade_state){case"success":i?$("trade_state").text("交易被抢先!"):$("trade_state").text("交易成功!");break;case"refused":t=e.accepter==user_index?"":"对方",$("trade_state").text(t+"拒绝交易!");break;case"canceled":$("trade_state").text("交易被取消!")}$("#action_trade_items").text("关闭窗口").removeClass("disabled"),game_temp.action_trade_items_function=close_trade_window}$("#action_refuse_trade_items").hide(),$("special_actions").children().filter(function(){return parseInt($(this).attr("target_val"))==e.starter}).hide(),0==e.accepter&&$("special_actions").children().filter(function(){return"0"==parseInt($(this).attr("target_val"))}).hide()},info_window={set:function(e){$("info_window").children().empty(),$("info_window help_text").text(e)},set_addition:function(e){$("info_window alert_text").text(e)},clear:function(){$("info_window").children().empty()},empty:function(){this.clear()},push:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"help";t="help"==t?"help_text":"alert_text",$("info_window "+t).append("<div>"+e+"</div>")}},his_window={push:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"normal";$("his_text").append("<his_text_line class='"+t+"'>"+e+"</his_text_line>")},player_get_item:function(e,t,i){if(0!=i){var a=i>0?"获得":"失去";i=i>0?i:-i,this.push(e.name+" "+a+" "+order_ch[t]+" x "+i)}},clear:function(){$("his_text").empty()}},confirm_window={set:function(e){$("alert_text").text(""+e)},clear:function(){$("alert_text").text("")},show:function(){$("confirm_window").show()},hide:function(){$("confirm_window").hide()}},timer={reset:function(){0==$gameSystem.time_per_turn?$("timer-container").hide():$("timer-container").show();var e=$gameSystem.time_per_turn/2+"s";$("timer.right content").attr("style","transition-duration:"+e),$("timer.left content").attr("style","transition-duration:"+e+";transition-delay:"+e+";")},start:function(){$("timer").children().addClass("active").show(),$("timer").children().addClass("active").addClass("play"),$gameSystem.is_own_turn()&&(this.timer_id=setTimeout(timer.finished,1e3*$gameSystem.time_per_turn))},stop:function(){$("timer").children().removeClass("active play").hide(),game_info.step_list[game_info.step_index]==user_index&&clearTimeout(this.timer_id)},finished:function(){ws.sendmsg("mes_action",{val:[6]})}},$(document).ready(function(){function e(e){if(13==e.keyCode){var t=$("#talk_msg_input_window").val();""!=t&&ws.sendmsg("mes_action",{starter:user_index,val:[19,t]})}}$("actions0").hide(),$("actions1").children().not("actions2").hide(),$("button").filter(function(){return 1==$(this).attr("action_lv")}).filter("#1").hide(),$("dice").hide(),$("source_list").hide(),$("special_actions").children().hide(),$(".flex_window").each(function(){this.flex_min_width=$(this).attr("flex_min_width"),this.flex_min_height=$(this).attr("flex_min_height")}),$("#confirm_action").click(function(){if($("confirm_window").hide(),""!=game_temp.set_option){switch(game_temp.set_option){case"setting_no_robbing":game_temp.selected_player=0}game_temp.setting_option=""}if(1==game_temp.end_confirm)return void(game_temp.end_confirm=!1);switch(game_temp.action_now){case"action_build_road":ws.sendmsg("mes_action",{starter:user_index,val:[1,1,game_temp.selected_edge]});break;case"action_build_city0":ws.sendmsg("mes_action",{starter:user_index,val:[1,2,game_temp.selected_point]});break;case"action_build_city1":ws.sendmsg("mes_action",{starter:user_index,val:[1,3,game_temp.selected_point]});break;case"action_buy_dev_card":if(0==game_temp.bank_dev_cards){his_window.push("发展卡已经被抽完了。");break}ws.sendmsg("mes_action",{starter:user_index,val:[1,4,0,game_temp.bank_dev_cards]});break;case"action_set_robber_for_7":0==game_temp.selected_player?ws.sendmsg("mes_action",{starter:user_index,val:[4,game_temp.selected_place,game_temp.selected_player,0,1]}):ws.sendmsg("mes_action",{starter:user_index,val:[4,game_temp.selected_place,game_temp.selected_player,0,all_src_num(game_info.players[game_temp.selected_player])]});break;case"action_use_dev_soldier":0==game_temp.selected_player?ws.sendmsg("mes_action",{starter:user_index,val:[3,1,game_temp.selected_place,game_temp.selected_player,0,1]}):ws.sendmsg("mes_action",{starter:user_index,val:[3,1,game_temp.selected_place,game_temp.selected_player,0,all_src_num(game_info.players[game_temp.selected_player])]});break;case"action_use_dev_plenty":ws.sendmsg("mes_action",{starter:user_index,val:[3,2,game_temp.selected_src]});break;case"action_use_dev_monopoly":ws.sendmsg("mes_action",{starter:user_index,val:[3,3,game_temp.selected_src]});break;case"action_use_dev_road_making":ws.sendmsg("mes_action",{starter:user_index,val:[3,4,game_temp.selected_edge[0],game_temp.selected_edge[1]]});break;case"action_show_score_cards":ws.sendmsg("mes_action",{starter:user_index,val:[3,5,game_temp.selected_score_card]});break;case"fst_set_home":game_temp.home_step%2==0?ws.sendmsg("mes_action",{starter:user_index,val:[8,game_temp.home_step,game_temp.selected_point]}):ws.sendmsg("mes_action",{starter:user_index,val:[8,game_temp.home_step,game_temp.selected_edge]});break;case"alert":$("wait_window").hide()}game_temp.set_option=""}),$("#cancel_action").click(function(){close_confirm_window()}),$("#cancel_robbing").click(function(){game_temp.set_option="setting_no_robbing",confirm_window.set("确定不掠夺任何玩家?"),confirm_window.show()}),$("#to_before_action").click(function(){switch(clear_selectors(),game_temp.action_now){case"action_set_robber_for_7":case"action_use_dev_soldier":UI_start_robber_set();break;case"action_use_dev_road_making":clear_selectors();var e=available_edges(user_index);game_temp.selected_edge=[];for(var t in e){$("edge_selector").filter("#"+e[t]).addClass("active selector_available").show()}}$("special_actions").children().hide()}),$("#his_latest_button").click(function(){$("his_text").hasClass("latest")?($(this).attr("src","/media/img/latest_button.png"),$("his_text").removeClass("latest")):($(this).attr("src","/media/img/latest_button_down.png"),$("his_text").addClass("latest"))}),$("actions0").on("mouseenter","button",function(){$(this).attr("help")&&(info_window.set($(this).attr("help")),$("info_window").show()),$(this).attr("tip")&&$(this).hasClass("part_disabled")&&(info_window.set_addition($(this).attr("tip")),$("info_window").show())}),$("actions0").on("mouseleave","button",function(){$("info_window").hide()}),$("map").on("mouseenter",".selector_disabled",function(){$(this).hasClass("part_disabled")||$(this).attr("tip")&&(info_window.set($(this).attr("tip")),$("info_window").show())}),$("map").on("mouseleave",".selector_disabled",function(){$("info_window").hide()}),$("#places").on("mouseenter","plc_selector",function(){if(debug){var e=$(this).attr("id"),t=map_info.places[e];$("#plc_info").text("地块id："+e+"产出数字："+t.create_num+"产出类型："+order[t.create_type]),""!=$(this).attr("tip")&&(info_window.empty(),info_window.push($(this).attr("tip")),$("info_window").show())}}),$("#places").on("click","plc_selector",function(){if(0!=$(this).hasClass("selector_available")){if($(this).addClass("selector_selected"),confirm_window.clear(),"action_set_robber_for_7"==game_temp.action_now||"action_use_dev_soldier"==game_temp.action_now){game_temp.selected_place=parseInt($(this).attr("id"));var e=!1,t=plc_round_points($(this).attr("id"));for(var i in t)if(game_info.cities.hasOwnProperty(t[i])){var a=game_info.cities[t[i]];user_index!=a.owner&&(e=!0,$("player").filter("#"+a.owner).addClass("active player_select_available"))}if(e)return his_window.push("请选择要掠夺的玩家:"),$("plc_selector").not($(this)).removeClass("selector_available"),void show_special_actions("cancel_robbing","to_before_action");confirm_window.set("此处没有可以掠夺的城市,要将强盗放在这里吗?"),game_temp.selected_player=0}confirm_window.show()}}),$("#places").on("mouseleave","plc_selector",function(){$("info_window").hide()}),$("#edges").on("mouseenter","edge_selector",function(){debug&&($("#plc_info").text("边id："+$(this).attr("id")),""!=$(this).attr("tip")&&(info_window.set($(this).attr("tip")),$("info_window").show()))}),$("#edges").on("click","edge_selector",function(){if(!$(this).hasClass("selector_disabled")&&!$(this).hasClass("selector_selected"))if($(this).addClass("selector_selected"),confirm_window.clear(),"action_build_road"==game_temp.action_now||"fst_set_home"==game_temp.action_now)game_temp.selected_edge=parseInt($(this).attr("id")),confirm_window.set("要在此处建造道路吗?"),confirm_window.show();else if("action_use_dev_road_making"==game_temp.action_now)if(game_temp.selected_edge.push(parseInt($(this).attr("id"))),1==game_temp.selected_edge.length){show_special_actions("to_before_action");var e=available_edges(user_index,game_temp.selected_edge);for(var t in e){$("edge_selector").filter("#"+e[t]).addClass("active selector_available").show()}}else confirm_window.set("要在这两处建造道路吗?"),confirm_window.show()}),$("#edges").on("mouseleave","edge_selector",function(){$("info_window").hide()}),$("#points").on("mouseenter","pt_selector",function(){debug&&($("#plc_info").text("点id："+$(this).attr("id")),""!=$(this).attr("tip")&&(info_window.set($(this).attr("tip")),$("info_window").show()))}),$("#points").on("click","pt_selector",function(){$(this).hasClass("selector_disabled")||(game_temp.selected_point=parseInt($(this).attr("id")),confirm_window.clear(),"action_build_city0"==game_temp.action_now||"fst_set_home"==game_temp.action_now?confirm_window.set("要在此处建立定居点吗?"):"action_build_city1"==game_temp.action_now&&confirm_window.set("要将该定居点升级成城市吗?"),$(this).addClass("selector_selected"),confirm_window.show())}),$("#points").on("mouseleave","pt_selector",function(){$("info_window").hide()}),$("#players").on("click","player",function(){0!=$(this).hasClass("active")&&(game_temp.selected_player=parseInt($(this).attr("id")),confirm_window.clear(),"action_set_robber_for_7"!=game_temp.action_now&&"action_use_dev_soldier"!=game_temp.action_now||(0==all_src_num(game_info.players[game_temp.selected_player])?(confirm_window.set("该玩家没有资源卡可以掠夺。"),game_temp.end_confirm=!0):(game_temp.selected_player=parseInt($(this).attr("id")),confirm_window.set("要掠夺该玩家吗?"))),$(this).addClass("player_select_selected"),confirm_window.show())}),$("src_select_window").on("click","src_item",function(){if("action_trade"!=game_temp.action_now||"prepare"==game_temp.trade_now.trade_state){var e=$(this).attr("id"),t=game_UI[e],i=t.rlt_item;switch(t.can_reduce()&&(t.reduce(),i.increase()),game_temp.action_now){case"action_drop_srcs_for_7":game_temp.dropped==game_temp.drop_required?$("#action_confirm_selected_items").removeClass("disabled"):$("#action_confirm_selected_items").addClass("disabled"),$("#item_count").text(""+game_temp.dropped);break;case"action_trade":game_temp.trade_basic_get_num!=game_temp.trade_basic_give_num&&"player"!=game_temp.trade_target||0==game_temp.trade_basic_give_num?$("#action_trade_items").addClass("disabled"):$("#action_trade_items").removeClass("disabled");break;case"action_use_dev_plenty":game_temp.plenty_count==game_temp.item_top_limit?$("#action_confirm_selected_items").removeClass("disabled"):$("#action_confirm_selected_items").addClass("disabled"),$("#item_count").text(""+game_temp.plenty_count)}}}),$("confirm_window").on("click","#close",function(){close_confirm_window()}),$("simple_item_select_window").on("click","#close",function(){close_simple_item_select_window()}),$("trade_window").on("click","#close",function(){"requesting_trade"!=game_temp.trade_step&&close_trade_window()}),$("#action_confirm_selected_items").click(function(){if(!$(this).hasClass("disabled")){var e={},t=null;switch(game_temp.action_now){case"action_drop_srcs_for_7":t=game_UI_list.drop_items.selected;break;case"action_use_dev_plenty":t=game_UI_list.plenty_items.selected}var i=!0,a=!1,s=void 0;try{for(var n,r=t[Symbol.iterator]();!(i=(n=r.next()).done);i=!0){var o=n.value,_=game_UI[o];0!=_.own_num&&(e[src_reflection[_.item_type]]=_.own_num)}}catch(e){a=!0,s=e}finally{try{!i&&r.return&&r.return()}finally{if(a)throw s}}switch(game_temp.action_now){case"action_drop_srcs_for_7":ws.sendmsg("mes_action",{starter:user_index,val:[5,e]});break;case"action_use_dev_plenty":ws.sendmsg("mes_action",{starter:user_index,val:[3,2,e]})}}}),$("#action_trade_items").click(function(){$(this).hasClass("disabled")||game_temp.action_trade_items_function()}),$("#action_refuse_trade_items").click(function(){refuse_trade()}),$("#action_dice").click(function(){0==game_info.dice_num[0]&&(1==game_info.game_process?ws.sendmsg("mes_action",{starter:user_index,val:[9,0]}):ws.sendmsg("mes_action",{val:[0,0]}))}),$("#action_contribute").click(function(){if(0!=init_menu_lv(0,$(this))){$(this).addClass("active");var e=["#action_build_road","#action_build_city0","#action_build_city1","#action_buy_dev_card"],t=!0,i=!1,a=void 0;try{for(var s,n=e[Symbol.iterator]();!(t=(s=n.next()).done);t=!0){var r=s.value;$(r).show(),$gameSystem.self_player().no_build_dev_used&&$(r).attr("tip","本回合使用过垄断等使用后禁止建设的发展卡").addClass("part_disabled")}}catch(e){i=!0,a=e}finally{try{!t&&n.return&&n.return()}finally{if(i)throw a}}$("actions1").css("top",$(this).position().top-75)}}),$("#action_trade").click(function(){0!=init_menu_lv(0,$(this))&&($(this).addClass("active"),$("#action_trade_with_bank").show(),$("#action_trade_with_harbours").show(),$("#action_trade_with_players").show(),$("actions1").css("top",$(this).position().top-50))}),$("#action_trade_with_harbours").click(function(){if(0!=init_menu_lv(1,$(this))){$(this).addClass("active");var e=all_harbours(user_index),t=-1;for(var i in e)$("actions2").children().filter(function(){return"harbour"==$(this).attr("trade_target")&&$(this).attr("target_val")==e[i]}).show(),t++;$("actions2").css("top",$(this).position().top-25*t)}}),$("#action_trade_with_players").click(function(){if(0!=init_menu_lv(1,$(this))){$(this).addClass("active");var e=-1;for(var t in game_info.players)if(t!=user_index){var i=$("actions2").children().filter(function(){return"player"==$(this).attr("trade_target")&&$(this).attr("target_val")==t});-1==game_info.online_list.indexOf(parseInt(t))?i.addClass("disabled"):i.removeClass("disabled"),i.show(),e++}$("actions2").css("top",$(this).position().top-25*e)}}),$("actions1").on("click",".action_prepare_trade",function(){if(!$(this).hasClass("disabled")){if($(this).parent().is("actions1")){if(0==init_menu_lv(1,$(this)))return}else if(0==init_menu_lv(2,$(this)))return;$(this).addClass("active"),start_trade_window($(this).attr("trade_target"),$(this).attr("target_val"))}}),$("special_actions").on("click",".action_prepare_trade",function(){$(this).addClass("active"),start_trade_window($(this).attr("trade_target"),$(this).attr("target_val"))}),$("#action_develop").click(function(){if(0!=init_menu_lv(0,$(this))){for(var e=(game_info.players[user_index],0);e<4;e++)$("#action_use_dev_"+devs[e]).show();var t=UI_use_dev_update();-1!=t&&($(this).addClass("active"),$("actions1").css("top",$(this).position().top-25*t))}}),$("#action_build_road").click(function(){if(0!=init_menu_lv(1,$(this))){game_temp.action_now="action_build_road";var e=available_edges(user_index),t=game_info.players[user_index];for(var i in e){var a=$("edge_selector").filter("#"+e[i]);a.addClass("active").show(),0==t.brick_num||0==t.wood_num?a.attr("tip","资源不足").addClass("selector_disabled"):a.addClass("selector_available")}$(this).addClass("active")}}),$("#action_build_city0").click(function(){if(0!=init_menu_lv(1,$(this))){game_temp.action_now="action_build_city0";var e=available_points(user_index),t=game_info.players[user_index];for(var i in e){var a=$("pt_selector").filter("#"+e[i]);a.addClass("active").show(),0==t.brick_num||0==t.wood_num||0==t.wool_num||0==t.grain_num?a.attr("tip","资源不足").addClass("selector_disabled"):a.addClass("selector_available")}$(this).addClass("active")}}),$("#action_build_city1").click(function(){if(0!=init_menu_lv(1,$(this))){game_temp.action_now="action_build_city1";var e=game_info.players[user_index],t=city_num(e,0,"all");for(var i in t){var a=$("pt_selector").filter("#"+t[i]);a.addClass("active").show(),e.grain_num<2||e.ore_num<3?a.attr("tip","资源不足").addClass("selector_disabled"):a.addClass("selector_available")}$(this).addClass("active")}}),$("#action_buy_dev_card").click(function(){if(0!=init_menu_lv(1,$(this))){var e=game_info.players[user_index];if(0==e.wool_num||0==e.grain_num||0==e.ore_num)return game_temp.action_now="alert",confirm_window.set("资源不足！"),void confirm_window.show();game_temp.action_now="action_buy_dev_card",game_temp.bank_dev_cards=game_info.cards.soldier_num+game_info.cards.plenty_num+game_info.cards.monopoly_num+game_info.cards.road_making_num+game_info.cards.score_cards.length,confirm_window.set("要抽取发展卡吗?"),confirm_window.show()}}),$("#action_use_dev_soldier").click(function(){$(this).hasClass("part_disabled")||0!=init_menu_lv(1,$(this))&&(game_temp.action_base="action_use_dev_soldier",game_temp.action_now="action_use_dev_soldier",his_window.push("由你设置强盗:"),UI_start_robber_set(),$(this).addClass("active"))}),$("#action_use_dev_plenty").click(function(){$(this).hasClass("part_disabled")||0!=init_menu_lv(1,$(this))&&(game_temp.action_now="action_use_dev_plenty",game_temp.item_top_limit=2,his_window.push("选择要丰收的资源:"),UI_start_plenty_select(),$(this).addClass("active"),$("actions2").css("top",$(this).position().top-100))}),$("#action_use_dev_monopoly").click(function(){$(this).hasClass("part_disabled")||0!=init_menu_lv(1,$(this))&&(game_temp.action_now="action_use_dev_monopoly",his_window.push("选择要垄断的资源:"),$(".src_selector").show(),$(this).addClass("active"),$("actions2").css("top",$(this).position().top-100))}),$("#action_show_score_cards").click(function(){if(!$(this).hasClass("part_disabled")&&0!=init_menu_lv(1,$(this))){game_temp.action_now="action_show_score_cards",his_window.push("选择要展示的分数卡:"),$(this).addClass("active");var e=$(".score_card_selector").filter(function(){return-1!=$gameSystem.self_player().score_unshown.indexOf($(this).text())}),t=e.length-1;e.show(),$("actions2").css("top",$(this).position().top-25*t)}}),$("actions1").on("click",".src_selector",function(){$(this).hasClass("disabled")||0!=init_menu_lv(2,$(this))&&($(this).addClass("active"),game_temp.selected_src=$(this).attr("src_id"),"action_use_dev_monopoly"==game_temp.action_now?confirm_window.set("要垄断"+order_ch[game_temp.selected_src]+"吗?"):"action_use_dev_plenty"==game_temp.action_now&&confirm_window.set("要丰收"+order_ch[game_temp.selected_src]+"吗?"),confirm_window.show())}),$("actions1").on("click",".score_card_selector",function(){$(this).hasClass("disabled")||0!=init_menu_lv(2,$(this))&&($(this).addClass("active"),game_temp.selected_score_card=$(this).text(),confirm_window.set("要展示"+$(this).text()+"吗?"),confirm_window.show())}),$("#action_use_dev_road_making").click(function(){if(!$(this).hasClass("part_disabled")&&0!=init_menu_lv(1,$(this))){$(this).addClass("active"),game_temp.action_now="action_use_dev_road_making",game_temp.selected_edge=[];var e=available_edges(user_index);for(var t in e){$("edge_selector").filter("#"+e[t]).addClass("active selector_available").show()}}}),$("#action_end_turn").click(function(){timer.stop(),ws.sendmsg("mes_action",{val:[6]})}),$("#players").on("mouseenter","vp_state",function(e){info_window.empty();var t=vp_info(game_info.players[$(this).attr("id")],$(this).attr("id"));for(var i in t)0!=t[i]&&info_window.push(vp_info_text[i]+t[i]);$("info_window").fadeIn("fast")}),$("#players").on("mouseleave","vp_state",function(e){$("info_window").hide()}),$("#players").on("mouseenter","longest_road",function(e){info_window.empty();var t=$(this).attr("id"),i=game_info.players[t].road_longest;game_info.longest_road==t?info_window.push("已建成最长道路:"+i.length):info_window.push("目前的最长道路:"+i.length),$("edge_selector").filter(function(){return-1!=i.indexOf(parseInt($(this).attr("id")))}).css({color:color_reflection_hex[color_reflection[$(this).attr("id")]]}).addClass("selector_displaying").show(),$("info_window").fadeIn("fast")}),$("#players").on("mouseleave","longest_road",function(e){$("edge_selector").css("color","").removeClass("displaying"),$("edge_selector").each(function(){0==$(this).hasClass("active")&&$(this).hide()}),$("info_window").hide()}),$("#players").on("mouseenter","max_minitory",function(e){info_window.empty();var t=$(this).attr("id");game_info.max_minitory==t?info_window.push("已拥有最大军队:"+game_info.players[t].soldier_used):info_window.push("目前的军队:"+game_info.players[t].soldier_used),$("info_window").fadeIn("fast")}),$("#players").on("mouseleave","max_minitory",function(e){$("info_window").hide()}),$("#players").on("mouseenter","score_card",function(e){info_window.empty();var t=$(this).attr("id"),i=game_info.players[t].score_shown;if(0==i.length)info_window.push("尚未拥有奇观");else{info_window.push("已建成的奇观:");for(var a in i)info_window.push(i[a])}$("info_window").fadeIn("fast")}),$("#players").on("mouseleave","score_card",function(e){$("info_window").hide()}),$("body").mousemove(function(e){"none"!=$("info_window").css("display")&&$("info_window").css({left:e.pageX+10,top:e.pageY-20})}),$("body").click(function(){$("info_window").hide()}),$("#talk_msg_input_window").keydown(function(t){e(t)}),$("#talk_msg_input_window_send").click(function(){e({keyCode:13})}),$(document).mousemove(function(e){if(this.move){var t=document.move_target?document.move_target.posix:{x:0,y:0};(document.call_down||function(){e.scrollY;$(this.move_target).css({top:e.clientY-t.y,left:e.clientX-t.x})}).call(this,e,t)}}).mouseup(function(e){if(this.move){(document.call_up||function(){}).call(this,e),$.extend(this,{move:!1,move_target:null,call_down:!1,call_up:!1})}});$(".flex_window").mousedown(function(e){var t=$(this).offset();this.posix={x:e.pageX-t.left,y:e.pageY-t.top},$.extend(document,{move:!0,move_target:this})}).on("mousedown","#resize",function(e){var t=$(this).parent().parent(),i={w:t.width(),h:t.height(),top:t.offset().top,x:e.pageX,y:e.pageY,min_width:t.get(0).flex_min_width,min_height:t.get(0).flex_min_height};return $.extend(document,{move:!0,call_down:function(e){t.css({top:Math.min(i.top+i.h-i.min_height,e.pageY-i.y+i.top),width:Math.max(i.min_width,e.pageX-i.x+i.w),height:Math.max(i.min_height,-e.pageY+i.y+i.h)})}}),!1})});var Src_item=function(){function e(t,i,a){_classCallCheck(this,e),this.jqdom=t,this.rlt_item=i,this.item_type=a,this.ratio_num=0,this.own_num=0}return _createClass(e,[{key:"reduce",value:function(){this.own_num-=this.ratio_num,this.jqdom_update()}},{key:"increase",value:function(){this.own_num+=this.ratio_num,this.jqdom_update()}},{key:"jqdom_update",value:function(){this.jqdom.attr("num",this.own_num)}},{key:"jqdom_init",value:function(){0==this.own_num?this.jqdom.hide():this.jqdom.show(),this.jqdom_update()}}]),e}(),Selected_item=function(e){function t(e,i,a){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i,a))}return _inherits(t,e),_createClass(t,[{key:"can_reduce",value:function(){return this.own_num>=this.ratio_num}},{key:"jqdom_update",value:function(){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"jqdom_update",this).call(this),0==this.own_num?this.jqdom.hide():this.jqdom.show()}}]),t}(Src_item),Available_item=function(e){function t(e,i,a){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i,a))}return _inherits(t,e),_createClass(t,[{key:"can_reduce",value:function(){return!(this.own_num<this.ratio_num)}},{key:"jqdom_update",value:function(){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"jqdom_update",this).call(this),this.own_num<this.ratio_num?this.jqdom.addClass("disabled"):this.jqdom.removeClass("disabled")}}]),t}(Src_item),Selected_Drop_item=function(e){function t(e,i,a){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i,a))}return _inherits(t,e),_createClass(t,[{key:"reduce",value:function(){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"reduce",this).call(this),game_temp.dropped--}},{key:"increase",value:function(){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"increase",this).call(this),game_temp.dropped++}}]),t}(Selected_item),Available_Drop_item=function(e){function t(e,i,a){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i,a))}return _inherits(t,e),_createClass(t,[{key:"can_reduce",value:function(){return 0!=_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"can_reduce",this).call(this)&&game_temp.dropped!=game_temp.drop_required}}]),t}(Available_item),Selected_Plenty_item=function(e){function t(e,i,a){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i,a))}return _inherits(t,e),_createClass(t,[{key:"reduce",value:function(){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"reduce",this).call(this),game_temp.plenty_count--}},{key:"increase",value:function(){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"increase",this).call(this),game_temp.plenty_count++}}]),t}(Selected_item),Available_Plenty_item=function(e){function t(e,i,a){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i,a))}return _inherits(t,e),_createClass(t,[{key:"can_reduce",value:function(){return 0!=_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"can_reduce",this).call(this)&&game_temp.plenty_count!=game_temp.item_top_limit}}]),t}(Available_item),Selected_Trade_item=function(e){function t(e,i,a,s){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i,a));return n.own_type=s,n.secret=!1,n}return _inherits(t,e),_createClass(t,[{key:"reduce",value:function(){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"reduce",this).call(this),"get"==this.own_type?game_temp.trade_basic_get_num--:"give"==this.own_type&&game_temp.trade_basic_give_num--}},{key:"increase",value:function(){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"increase",this).call(this),
"get"==this.own_type?game_temp.trade_basic_get_num++:"give"==this.own_type&&game_temp.trade_basic_give_num++}}]),t}(Selected_item),Available_Trade_item=function(e){function t(e,i,a,s){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i,a));return n.own_type=s,n.secret=!1,n}return _inherits(t,e),_createClass(t,[{key:"can_reduce",value:function(){return 0!=_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"can_reduce",this).call(this)&&!("give"==this.own_type&&game_temp.trade_basic_give_num>=game_temp.trade_basic_get_num&&"player"!=game_temp.trade_target)}},{key:"jqdom_update",value:function(){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"jqdom_update",this).call(this),this.secret&&this.jqdom.attr("num","--"),this.own_num<0?this.jqdom.addClass("tooless"):this.jqdom.removeClass("tooless")}}]),t}(Available_item);ws={};